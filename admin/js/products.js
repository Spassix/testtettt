let products=[],sortKey="category",sortDir="asc",searchQuery="",filterCategory="toutes",filterFarm="",editingProductId=null;async function initProducts(){await loadProducts(),setupProductsUI(),await populateCategoriesAndFarms()}async function loadProducts(){products=await BackendData.loadData("products"),renderProductsTable()}async function saveProducts(){await BackendData.saveData("products",products)}function renderProductsTable(){const tbody=document.getElementById("productsTableBody");if(!tbody)return;if(0===products.length)return void(tbody.innerHTML='<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucun produit</td></tr>');const needle=(searchQuery||"").trim().toLowerCase();let filtered=needle?products.filter(p=>{const name=(p.name||"").toLowerCase(),cat=(p.category||"").toLowerCase(),farm=(p.farm||"").toLowerCase();return name.includes(needle)||cat.includes(needle)||farm.includes(needle)}):[...products];filtered=filtered.filter(p=>!("toutes"!==filterCategory&&p.category!==filterCategory||filterFarm&&p.farm!==filterFarm));const sorted=filtered.sort((a,b)=>{const dir="desc"===sortDir?-1:1,val=(obj,key)=>"price"===key?Number(obj.price||0):(obj[key]||"").toString().toLowerCase(),va=val(a,sortKey),vb=val(b,sortKey);if(va<vb)return-1*dir;if(va>vb)return 1*dir;const ca=(a.category||"").toLowerCase(),cb=(b.category||"").toLowerCase();if(ca<cb)return-1;if(ca>cb)return 1;const na=(a.name||"").toLowerCase(),nb=(b.name||"").toLowerCase();return na<nb?-1:na>nb?1:0});let lastCategory=null;tbody.innerHTML=sorted.map(p=>{const currentCat=p.category||"‚Äî";let groupHeader="";currentCat!==lastCategory&&(lastCategory=currentCat,groupHeader=`\n        <tr class="group-row">\n          <td colspan="6" style="background: rgba(255,255,255,0.03); color: var(--text-secondary); font-weight: 600; letter-spacing: .3px;">\n            Cat√©gorie: ${AdminUtils.escapeHtml(currentCat)}\n          </td>\n        </tr>`);const photo=p.photo||p.image||p.media||"";let mediaHtml="";mediaHtml=photo?`<img src="${AdminUtils.escapeHtml(photo)}" alt="thumb" style="width:56px;height:56px;object-fit:cover;border-radius:10px;">`:'<div style="width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;color:#777">‚Äî</div>';let priceLabel="0.00‚Ç¨";if(Array.isArray(p.quantities)&&p.quantities.length>0){const prices=p.quantities.map(q=>Number(q.price)||0).filter(n=>!isNaN(n));if(prices.length>0){const min=Math.min(...prices),max=Math.max(...prices);priceLabel=min===max?`${min.toFixed(2)}‚Ç¨`:`${min.toFixed(2)}‚Ç¨ / ${max.toFixed(2)}‚Ç¨`}}else"number"==typeof p.price&&(priceLabel=`${p.price.toFixed(2)}‚Ç¨`);const chips=[p.category?`<span class="pm-chip" style="background:rgba(99,102,241,.15);color:#c7c9ff;border:1px solid rgba(99,102,241,.35);padding:.15rem .5rem;border-radius:999px;font-size:.75rem">${AdminUtils.escapeHtml(p.category)}</span>`:"",p.farm?`<span class="pm-chip" style="background:rgba(56,189,248,.12);color:#a8e9ff;border:1px solid rgba(56,189,248,.35);padding:.15rem .5rem;border-radius:999px;font-size:.75rem">${AdminUtils.escapeHtml(p.farm)}</span>`:""].filter(Boolean).join(" "),featured=p.featured?'<span title="En vedette" style="margin-left:.25rem">‚≠ê</span>':"";return`\n    ${groupHeader}\n    <tr>\n      <td data-label="M√©dia">${mediaHtml}</td>\n      <td data-label="Nom">\n        <div style="font-weight:600">${AdminUtils.escapeHtml(p.name||"")}${featured}</div>\n        <div style="margin-top:.25rem;display:flex;gap:.35rem;flex-wrap:wrap">${chips}</div>\n      </td>\n      <td data-label="Cat√©gorie" class="hide-md">${AdminUtils.escapeHtml(p.category||"")}</td>\n      <td data-label="Farm" class="hide-md">${AdminUtils.escapeHtml(p.farm||"-")}</td>\n      <td data-label="Prix">${priceLabel}</td>\n      <td data-label="Actions">\n        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">\n          <button class="btn-secondary" onclick="editProduct(${p.id})">√âditer</button>\n          <button class="btn-danger" onclick="deleteProduct(${p.id})">Supprimer</button>\n        </div>\n      </td>\n    </tr>`}).join(""),generateVideoThumbnails(tbody)}function generateVideoThumbnails(rootEl){if(!rootEl)return;const items=Array.from(rootEl.querySelectorAll(".video-thumb[data-video-url]"));0!==items.length&&items.forEach(node=>{const url=node.getAttribute("data-video-url");if(!url)return;const cacheKey=`thumb_cache_${encodeURIComponent(url)}`,cached=localStorage.getItem(cacheKey);if(cached){const img=document.createElement("img");return img.src=cached,img.alt="vid-thumb",img.style.cssText="width:56px;height:56px;object-fit:cover;border-radius:10px;display:block;",void node.parentNode.replaceChild(img,node)}try{const video=document.createElement("video");video.crossOrigin="anonymous",video.muted=!0,video.preload="metadata",video.playsInline=!0,video.src=url;let hasCaptured=!1;const onCapture=()=>{if(!hasCaptured){hasCaptured=!0;try{const canvas=document.createElement("canvas");canvas.width=112,canvas.height=112;const ctx=canvas.getContext("2d");video.readyState<2?(ctx.fillStyle="rgba(255,255,255,0.1)",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#9aa",ctx.font="14px Arial",ctx.textAlign="center",ctx.textBaseline="middle",ctx.fillText("VID",canvas.width/2,canvas.height/2)):ctx.drawImage(video,0,0,canvas.width,canvas.height);const dataUrl=canvas.toDataURL("image/jpeg",.7);if(dataUrl&&dataUrl.length>0){if(dataUrl.length<4e5)try{localStorage.setItem(cacheKey,dataUrl)}catch(e){console.warn("Impossible de sauvegarder la miniature en cache:",e)}const img=document.createElement("img");img.src=dataUrl,img.alt="vid-thumb",img.style.cssText="width:56px;height:56px;object-fit:cover;border-radius:10px;display:block;",node.parentNode&&node.parentNode.replaceChild(img,node)}}catch(e){console.warn("Erreur g√©n√©ration miniature:",e)}}},timeout=setTimeout(()=>{hasCaptured||onCapture()},5e3);video.addEventListener("loadeddata",()=>{if(!hasCaptured)if(isFinite(video.duration)&&video.duration>.5){const handler=()=>{clearTimeout(timeout),onCapture()};video.addEventListener("seeked",handler,{once:!0});try{video.currentTime=Math.min(1,.1*video.duration)}catch(_){clearTimeout(timeout),onCapture()}}else clearTimeout(timeout),onCapture()},{once:!0}),video.addEventListener("error",()=>{clearTimeout(timeout),hasCaptured||onCapture()},{once:!0}),video.load()}catch(err){console.warn("Erreur lors de la g√©n√©ration de la miniature:",err)}})}async function populateCategoriesAndFarms(){const categories=await BackendData.loadData("categories"),farms=await BackendData.loadData("farms"),catSelect=document.getElementById("productCategory"),farmSelect=document.getElementById("productFarm"),filterCat=document.getElementById("productsFilterCategory"),filterFarm=document.getElementById("productsFilterFarm");if(catSelect&&(catSelect.innerHTML='<option value="">S√©lectionner...</option>'+categories.map(c=>`<option value="${AdminUtils.escapeHtml(c.name)}">${AdminUtils.escapeHtml(c.name)}</option>`).join("")),farmSelect&&(farmSelect.innerHTML='<option value="">Aucune</option>'+farms.map(f=>`<option value="${AdminUtils.escapeHtml(f.name)}">${AdminUtils.escapeHtml(f.name)}</option>`).join("")),filterCat){const prev=filterCat.value||"toutes";filterCat.innerHTML='<option value="toutes">Toutes</option>'+categories.map(c=>`<option value="${AdminUtils.escapeHtml(c.name)}">${AdminUtils.escapeHtml(c.name)}</option>`).join(""),filterCat.value=prev}if(filterFarm){const prevF=filterFarm.value||"";filterFarm.innerHTML='<option value="">Toutes</option>'+farms.map(f=>`<option value="${AdminUtils.escapeHtml(f.name)}">${AdminUtils.escapeHtml(f.name)}</option>`).join(""),filterFarm.value=prevF}}let saveBtnHandler=null;function setupProductsUI(){const addBtn=document.getElementById("addProductBtn");if(addBtn){const newAddBtn=addBtn.cloneNode(!0);addBtn.parentNode.replaceChild(newAddBtn,addBtn),newAddBtn.addEventListener("click",()=>{openProductModal()})}const sortKeySelect=document.getElementById("productsSortKey"),sortDirSelect=document.getElementById("productsSortDir"),searchInput=document.getElementById("productsSearch"),catFilter=document.getElementById("productsFilterCategory"),farmFilter=document.getElementById("productsFilterFarm"),resetBtn=document.getElementById("productsResetFilters");if(sortKeySelect){const current=sortKey;sortKeySelect.value=current,sortKeySelect.addEventListener("change",()=>{sortKey=sortKeySelect.value||"name",renderProductsTable()})}if(sortDirSelect){const currentD=sortDir;sortDirSelect.value=currentD,sortDirSelect.addEventListener("change",()=>{sortDir=sortDirSelect.value||"asc",renderProductsTable()})}searchInput&&searchInput.addEventListener("input",AdminUtils.debounce(()=>{searchQuery=searchInput.value||"",renderProductsTable()},200)),catFilter&&catFilter.addEventListener("change",()=>{filterCategory=catFilter.value||"toutes",renderProductsTable()}),farmFilter&&farmFilter.addEventListener("change",()=>{filterFarm=farmFilter.value||"",renderProductsTable()}),resetBtn&&resetBtn.addEventListener("click",()=>{searchQuery="",filterCategory="toutes",filterFarm="",searchInput&&(searchInput.value=""),catFilter&&(catFilter.value="toutes"),farmFilter&&(farmFilter.value=""),sortKey="category",sortDir="asc",sortKeySelect&&(sortKeySelect.value=sortKey),sortDirSelect&&(sortDirSelect.value=sortDir),renderProductsTable()});const closeBtn=document.getElementById("productModalClose"),cancelBtn=document.getElementById("productModalCancel"),saveBtn=document.getElementById("productModalSave");if(closeBtn){const newCloseBtn=closeBtn.cloneNode(!0);closeBtn.parentNode.replaceChild(newCloseBtn,closeBtn),newCloseBtn.addEventListener("click",closeProductModal)}if(cancelBtn){const newCancelBtn=cancelBtn.cloneNode(!0);cancelBtn.parentNode.replaceChild(newCancelBtn,cancelBtn),newCancelBtn.addEventListener("click",closeProductModal)}if(saveBtn){saveBtnHandler&&saveBtn.removeEventListener("click",saveBtnHandler),saveBtnHandler=async function(e){e.preventDefault(),e.stopPropagation(),await saveProduct()},saveBtn.addEventListener("click",saveBtnHandler);const form=document.getElementById("productForm");form&&form.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation(),saveProduct()})}function setupMediaUpload(type,accept,uploadBtnId,fileInputId,urlInputId,urlBtnId,previewFn,maxSizeMB=500){const uploadBtn=document.getElementById(uploadBtnId),fileInput=document.getElementById(fileInputId),urlBtn=document.getElementById(urlBtnId),urlInput=document.getElementById(urlInputId);if(!uploadBtn||!fileInput)return void console.error(`‚ùå √âl√©ments upload ${type} non trouv√©s`);const newBtn=uploadBtn.cloneNode(!0);uploadBtn.parentNode.replaceChild(newBtn,uploadBtn),newBtn.onclick=function(e){e.preventDefault(),e.stopPropagation();const input=document.getElementById(fileInputId);input&&input.click()};const newInput=fileInput.cloneNode(!0);if(fileInput.parentNode.replaceChild(newInput,fileInput),newInput.onchange=async function(e){const file=e.target.files[0];if(!file)return;if(file.size>1024*maxSizeMB*1024)return void AdminUtils.showToast(`Fichier trop volumineux (max ${maxSizeMB} MB)`,"error");const preview=document.getElementById("updateProductPhotoPreview"===previewFn.name?"productPhotoPreview":"productVideoPreview");preview&&(preview.innerHTML='<div style="padding: 2rem; text-align: center; color: #fff;">‚è≥ Chargement en cours...</div>');try{const fileSize=file.size,sizeMB=(fileSize/1048576).toFixed(2),hasBackend=backendAPI.baseUrl&&""!==backendAPI.baseUrl.trim();let mediaUrl;if(hasBackend){const uploadResult=await backendAPI.uploadFile(file,"products");if(!uploadResult.success||!uploadResult.url)throw new Error("√âchec de l'upload");mediaUrl=uploadResult.url,AdminUtils.showToast(`‚úÖ Fichier upload√© vers le cloud (${sizeMB}MB)`,"success")}else{if(fileSize>2097152)return AdminUtils.showToast(`‚ö†Ô∏è Fichier trop volumineux (${sizeMB}MB). Configurez le backend pour uploader des fichiers volumineux.`,"error"),void(preview&&(preview.innerHTML='<div style="padding: 2rem; text-align: center; color: #ff6b6b;">‚ùå Fichier trop volumineux pour localStorage</div>'));if(mediaUrl=await AdminUtils.readFileAsDataURL(file),!mediaUrl)throw new Error("Erreur lors de la conversion du fichier")}const urlInputEl=document.getElementById(urlInputId);urlInputEl&&(urlInputEl.value=mediaUrl),previewFn&&previewFn(mediaUrl),hasBackend||AdminUtils.showToast("‚úÖ Fichier charg√© avec succ√®s!","success")}catch(error){console.error(`‚ùå Erreur upload ${type}:`,error),AdminUtils.showToast(`‚ùå Erreur: ${error.message||"Impossible de charger le fichier"}`,"error"),preview&&(preview.innerHTML='<div style="padding: 2rem; text-align: center; color: #ff6b6b;">‚ùå Erreur de chargement</div>')}e.target.value=""},urlBtn&&urlInput){const newUrlBtn=urlBtn.cloneNode(!0);urlBtn.parentNode.replaceChild(newUrlBtn,urlBtn),newUrlBtn.onclick=function(){const url=urlInput.value.trim();url?url.startsWith("http://")||url.startsWith("https://")||url.startsWith("data:")||url.startsWith("/")?(previewFn&&previewFn(url),AdminUtils.showToast("‚úÖ URL valid√©e","success")):AdminUtils.showToast("‚ö†Ô∏è Format URL invalide","error"):AdminUtils.showToast("‚ö†Ô∏è URL vide","error")},urlInput.addEventListener("paste",function(e){setTimeout(()=>{const url=this.value.trim();url&&(url.startsWith("http://")||url.startsWith("https://")||url.startsWith("data:")||url.startsWith("/"))&&previewFn&&previewFn(url)},100)})}}window.updateProductPhotoPreview=function(url){const preview=document.getElementById("productPhotoPreview");preview?url&&""!==url.trim()?preview.innerHTML=`<img src="${AdminUtils.escapeHtml(url)}" style="max-width: 100%; max-height: 300px; object-fit: contain; border-radius: 8px;" alt="Preview">`:preview.innerHTML="":console.error("productPhotoPreview non trouv√©")},window.updateProductVideoPreview=function(url){const preview=document.getElementById("productVideoPreview");preview?url&&""!==url.trim()?preview.innerHTML=`<video src="${AdminUtils.escapeHtml(url)}" controls style="max-width: 100%; max-height: 300px; border-radius: 8px;"></video>`:preview.innerHTML="":console.error("productVideoPreview non trouv√©")},setupMediaUpload("photo",0,"productPhotoUploadBtn","productPhotoFile","productPhotoUrl","productPhotoUrlBtn",window.updateProductPhotoPreview),setupMediaUpload("video",0,"productVideoUploadBtn","productVideoFile","productVideoUrl","productVideoUrlBtn",window.updateProductVideoPreview)}function openProductModal(product=null){editingProductId=product?.id||null;const modal=document.getElementById("productModal"),overlay=document.getElementById("modalOverlay"),form=document.getElementById("productForm");if(product){if(document.getElementById("productModalTitle").textContent="Modifier un produit",document.getElementById("productName").value=product.name||"",document.getElementById("productCategory").value=product.category||"",document.getElementById("productFarm").value=product.farm||"",document.getElementById("productPrice").value=product.price||"",document.getElementById("productUnit").value=product.unit||"",product.grammages)document.getElementById("productGrammages").value=product.grammages;else if(product.quantities&&product.quantities.length>0){const grammages=product.quantities.map(q=>String(q.grammage)).join(", ");document.getElementById("productGrammages").value=grammages}else document.getElementById("productGrammages").value="";if(product.customPrices)document.getElementById("productCustomPrices").value=product.customPrices;else if(product.quantities&&product.quantities.length>0){const prices=product.quantities.filter(q=>q.price!==product.price).map(q=>`${q.grammage}:${q.price}`).join(", ");document.getElementById("productCustomPrices").value=prices}else document.getElementById("productCustomPrices").value="";const photo=product.photo||(!product.media||/\.(mp4|mov|webm|ogg|m4v)$/i.test(product.media)||product.media.includes("video")?"":product.media)||product.image||"",video=product.video||(product.media&&(/\.(mp4|mov|webm|ogg|m4v)$/i.test(product.media)||product.media.includes("video"))?product.media:"")||"";document.getElementById("productPhotoUrl").value=photo,document.getElementById("productVideoUrl").value=video,document.getElementById("productDescription").value=product.description||"",document.getElementById("productFeatured").checked=product.featured||!1,window.updateProductPhotoPreview&&window.updateProductPhotoPreview(photo),window.updateProductVideoPreview&&window.updateProductVideoPreview(video)}else form.reset(),document.getElementById("productModalTitle").textContent="Ajouter un produit",window.updateProductPhotoPreview&&window.updateProductPhotoPreview(""),window.updateProductVideoPreview&&window.updateProductVideoPreview("");modal.classList.remove("hidden"),overlay.classList.remove("hidden"),populateCategoriesAndFarms()}function closeProductModal(){const modal=document.getElementById("productModal"),overlay=document.getElementById("modalOverlay");modal.classList.add("hidden"),overlay.classList.add("hidden"),editingProductId=null,window.updateProductPhotoPreview&&window.updateProductPhotoPreview(""),window.updateProductVideoPreview&&window.updateProductVideoPreview("")}let isSaving=!1;async function saveProduct(){if(isSaving)return void console.log("Sauvegarde d√©j√† en cours...");const form=document.getElementById("productForm");if(form.checkValidity()){isSaving=!0;try{const name=document.getElementById("productName").value.trim(),category=document.getElementById("productCategory").value,farm=document.getElementById("productFarm").value||"",basePrice=parseFloat(document.getElementById("productPrice").value)||0;let unit=document.getElementById("productUnit").value.trim()||"g";unit=unit.replace(/^\d+/,"").trim()||"g";const grammagesStr=document.getElementById("productGrammages").value.trim(),customPricesStr=document.getElementById("productCustomPrices").value.trim();let photo=document.getElementById("productPhotoUrl").value.trim(),video=document.getElementById("productVideoUrl").value.trim();const description=document.getElementById("productDescription").value.trim(),featured=document.getElementById("productFeatured").checked;if(!photo)return void AdminUtils.showToast("La photo est obligatoire","error");if(photo.startsWith("data:")&&backendAPI.baseUrl&&""!==backendAPI.baseUrl.trim()){const photoSize=new Blob([photo]).size,sizeMB=(photoSize/1048576).toFixed(2);if(photoSize>2097152)try{const matches=photo.match(/^data:([^;]+);base64,(.+)$/);if(matches){const mimeType=matches[1],base64Data=matches[2],byteCharacters=atob(base64Data),byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++)byteNumbers[i]=byteCharacters.charCodeAt(i);const byteArray=new Uint8Array(byteNumbers),blob=new Blob([byteArray],{type:mimeType}),file=new File([blob],`photo_${Date.now()}.${mimeType.split("/")[1]||"bin"}`,{type:mimeType});AdminUtils.showToast(`üì§ Upload de la photo (${sizeMB}MB) vers le cloud...`,"info");const uploadResult=await backendAPI.uploadFile(file,"products");uploadResult.success&&uploadResult.url&&(photo=uploadResult.url,document.getElementById("productPhotoUrl").value=photo,AdminUtils.showToast(`‚úÖ Photo upload√©e vers le cloud (${sizeMB}MB)`,"success"))}}catch(uploadError){console.error("‚ùå Erreur lors de l'upload automatique de la photo:",uploadError)}}if(video&&video.startsWith("data:")&&backendAPI.baseUrl&&""!==backendAPI.baseUrl.trim()){const videoSize=new Blob([video]).size,sizeMB=(videoSize/1048576).toFixed(2);if(videoSize>2097152)try{const matches=video.match(/^data:([^;]+);base64,(.+)$/);if(matches){const mimeType=matches[1],base64Data=matches[2],byteCharacters=atob(base64Data),byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++)byteNumbers[i]=byteCharacters.charCodeAt(i);const byteArray=new Uint8Array(byteNumbers),blob=new Blob([byteArray],{type:mimeType}),file=new File([blob],`video_${Date.now()}.${mimeType.split("/")[1]||"bin"}`,{type:mimeType});AdminUtils.showToast(`üì§ Upload de la vid√©o (${sizeMB}MB) vers le cloud...`,"info");const uploadResult=await backendAPI.uploadFile(file,"products");uploadResult.success&&uploadResult.url&&(video=uploadResult.url,document.getElementById("productVideoUrl").value=video,AdminUtils.showToast(`‚úÖ Vid√©o upload√©e vers le cloud (${sizeMB}MB)`,"success"))}}catch(uploadError){console.error("‚ùå Erreur lors de l'upload automatique de la vid√©o:",uploadError)}}let grammages=[];grammagesStr&&(grammages=grammagesStr.split(",").map(g=>g.trim()).filter(g=>g&&!isNaN(parseFloat(g))).map(g=>parseFloat(g)));const customPricesMap={};customPricesStr&&customPricesStr.split(",").forEach(pair=>{const trimmed=pair.trim();if(trimmed.includes(":")){const parts=trimmed.split(":");if(2===parts.length){const grammage=parts[0].trim(),price=parts[1].trim();grammage&&price&&!isNaN(parseFloat(grammage))&&!isNaN(parseFloat(price))&&(customPricesMap[parseFloat(grammage)]=parseFloat(price))}}});let quantities=[];grammages.length>0?(quantities=grammages.map(g=>{let price=customPricesMap[g];return void 0===price&&(price=basePrice*g),{grammage:g,unit:unit,price:price}}),Object.keys(customPricesMap).forEach(gStr=>{const g=parseFloat(gStr);grammages.includes(g)||isNaN(g)||quantities.push({grammage:g,unit:unit,price:customPricesMap[g]})}),quantities.sort((a,b)=>a.grammage-b.grammage)):basePrice>0&&(quantities=[{grammage:1,unit:unit,price:basePrice}]);const productData={name:name,category:category,farm:farm,price:basePrice,unit:unit,grammages:grammagesStr,customPrices:customPricesStr,quantities:quantities,photo:photo,video:video,description:description,featured:featured};if(!name||!category)return void AdminUtils.showToast("Le nom et la cat√©gorie sont obligatoires","error");if(editingProductId){const index=products.findIndex(p=>p.id===editingProductId);if(!(index>-1))return void AdminUtils.showToast("Produit non trouv√©","error");products[index]={...products[index],...productData},AdminUtils.showToast("Produit modifi√©","success")}else{if(products.find(p=>p.name.toLowerCase()===name.toLowerCase()&&p.category===category))return void AdminUtils.showToast("Un produit avec ce nom existe d√©j√† dans cette cat√©gorie","error");productData.id=Date.now(),productData.createdAt=(new Date).toISOString(),products.push(productData),AdminUtils.showToast("Produit ajout√©","success")}await saveProducts(),await loadProducts(),closeProductModal()}catch(error){console.error("Erreur lors de la sauvegarde:",error);let errorMessage="Erreur lors de la sauvegarde du produit";(error.message&&(error.message.includes("quota")||error.message.includes("exceeded")||error.message.includes("volumineus"))||error.message)&&(errorMessage=error.message),AdminUtils.showToast(errorMessage,"error")}finally{isSaving=!1}}else form.reportValidity()}async function editProduct(id){const product=products.find(p=>p.id===id);product&&openProductModal(product)}async function deleteProduct(id){AdminUtils.confirmAction("Supprimer ce produit?")&&(products=products.filter(p=>p.id!==id),await saveProducts(),await loadProducts(),AdminUtils.showToast("Produit supprim√©","success"))}window.editProduct=editProduct,window.deleteProduct=deleteProduct,window.Products={initProducts:initProducts,loadProducts:loadProducts};