async function initConfig(){await loadConfig(),setupConfigUI()}async function loadConfig(){const config=await BackendData.loadData("config");if(config.servicesText&&!config.servicesButtons&&(config.servicesButtons=[{id:Date.now(),icon:"üåø",title:"SERVICES",text:config.servicesText}],delete config.servicesText,await BackendData.saveData("config",config)),config.servicesButtons&&Array.isArray(config.servicesButtons)){const uniqueButtons=[],seen=new Set;if(config.servicesButtons.forEach(button=>{const key=`${button.id}-${button.title}-${button.text}`;seen.has(key)||!button.title&&!button.text||(seen.add(key),uniqueButtons.push(button))}),uniqueButtons.length<config.servicesButtons.length){const removedCount=config.servicesButtons.length-uniqueButtons.length;config.servicesButtons=uniqueButtons,await BackendData.saveData("config",config),AdminUtils.showToast(`${removedCount} bouton(s) dupliqu√©(s) supprim√©(s)`,"info")}}document.getElementById("heroTitle").value=config.heroTitle||"",document.getElementById("heroBrand").value=config.heroBrand||"",document.getElementById("heroSubtitle").value=config.heroSubtitle||"";const backendUrl=getBackendUrl();document.getElementById("backendUrl").value=backendUrl,config.backendUrl=backendUrl,await BackendData.saveData("config",config),backendAPI.setBaseUrl(backendUrl),window.syncManager&&syncManager.isPolling&&syncManager.stopPolling(),window.syncManager&&backendUrl&&await syncManager.init(),config.siteBackground&&updateSiteBgPreview(config.siteBackground),renderServicesButtons(config.servicesButtons||[]),backendAPI.setBaseUrl(backendUrl),checkBackendStatus()}function getBackendUrl(){const currentUrl=window.location.origin;if(currentUrl.includes("localhost")||currentUrl.includes("127.0.0.1")){const port=window.location.port||"80";return"80"===port||"443"===port||""===port?`${window.location.protocol}//${window.location.hostname}:8080`:currentUrl}return currentUrl}async function saveConfig(){const config={siteBackground:document.getElementById("siteBgUrl")?.value||"",heroTitle:document.getElementById("heroTitle").value.trim(),heroBrand:document.getElementById("heroBrand").value.trim(),heroSubtitle:document.getElementById("heroSubtitle").value.trim(),backendUrl:getBackendUrl(),servicesButtons:await getServicesButtons()};await BackendData.saveData("config",config),backendAPI.setBaseUrl(config.backendUrl),checkBackendStatus(),AdminUtils.showToast("Configuration sauvegard√©e","success")}function setupConfigUI(){if(setupConfigUI._initialized)return console.log("‚ö†Ô∏è setupConfigUI d√©j√† initialis√©, skip"),void(window._creatingService=!1);setupConfigUI._initialized=!0,window._creatingService=!1;const saveBtn=document.getElementById("saveConfigBtn");saveBtn&&saveBtn.addEventListener("click",async()=>{await saveConfig()}),setupSiteBgUpload(),setupServicesButtonsUI();const backendUrl=document.getElementById("backendUrl");backendUrl&&backendUrl.setAttribute("readonly","readonly")}function setupSiteBgUpload(){const uploadBtn=document.getElementById("siteBgUploadBtn"),fileInput=document.getElementById("siteBgFile"),urlBtn=document.getElementById("siteBgUrlBtn"),removeBtn=document.getElementById("removeSiteBgBtn"),urlInput=document.getElementById("siteBgUrl"),preview=document.getElementById("siteBgPreview");if(uploadBtn){uploadBtn.replaceWith(uploadBtn.cloneNode(!0));const newUploadBtn=document.getElementById("siteBgUploadBtn");newUploadBtn&&fileInput&&(newUploadBtn.addEventListener("click",()=>{fileInput.click()}),fileInput.addEventListener("change",async e=>{const file=e.target.files[0];if(file)try{preview&&(preview.innerHTML='<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Chargement...</div>');const fileSize=file.size,sizeMB=(fileSize/1048576).toFixed(2);let mediaUrl;if(backendAPI.baseUrl&&""!==backendAPI.baseUrl.trim()){console.log("üì§ Upload vers Vercel Blob...");const uploadResult=await backendAPI.uploadFile(file,"config");if(!uploadResult.success||!uploadResult.url)throw new Error("√âchec de l'upload");mediaUrl=uploadResult.url,console.log(`‚úÖ Upload r√©ussi: ${mediaUrl}`),AdminUtils.showToast(`‚úÖ Fichier upload√© vers le cloud (${sizeMB}MB)`,"success")}else{if(fileSize>2097152){const message=`‚ö†Ô∏è Fichier trop volumineux (${sizeMB}MB). Les fichiers de plus de 2MB n√©cessitent un backend configur√© avec Vercel Blob.`;return AdminUtils.showToast(message,"error"),preview&&(preview.innerHTML=`\n                  <div style="padding: 2rem; text-align: center; color: #ff6b6b;">\n                    <p style="font-weight: bold; margin-bottom: 1rem;">‚ùå Fichier trop volumineux pour localStorage</p>\n                    <p style="font-size: 0.9rem; margin-bottom: 1rem;">Taille: ${sizeMB}MB (limite: 2MB)</p>\n                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 1rem;">üí° Configurez le backend dans les param√®tres.</p>\n                  </div>\n                `),void(e.target.value="")}console.log("üì¶ Conversion en DataURL pour localStorage..."),mediaUrl=await AdminUtils.readFileAsDataURL(file)}urlInput&&(urlInput.value=mediaUrl),updateSiteBgPreview(mediaUrl),await saveConfig()}catch(error){console.error("Erreur upload image:",error),AdminUtils.showToast("Erreur lors de l'upload","error"),preview&&(preview.innerHTML="")}}))}if(urlBtn){urlBtn.replaceWith(urlBtn.cloneNode(!0));const newUrlBtn=document.getElementById("siteBgUrlBtn");newUrlBtn&&newUrlBtn.addEventListener("click",async()=>{const url=urlInput?.value.trim()||"";url&&(AdminUtils.isValidUrl(url)||url.startsWith("data:"))?(updateSiteBgPreview(url),await saveConfig(),AdminUtils.showToast("URL valid√©e","success")):AdminUtils.showToast("URL invalide","error")})}if(removeBtn){removeBtn.replaceWith(removeBtn.cloneNode(!0));const newRemoveBtn=document.getElementById("removeSiteBgBtn");newRemoveBtn&&newRemoveBtn.addEventListener("click",async()=>{urlInput&&(urlInput.value=""),updateSiteBgPreview(""),await saveConfig(),AdminUtils.showToast("Image supprim√©e","success")})}urlInput&&urlInput.addEventListener("paste",async()=>{setTimeout(async()=>{const url=urlInput.value.trim();url&&(AdminUtils.isValidUrl(url)||url.startsWith("data:"))&&(updateSiteBgPreview(url),await saveConfig())},100)})}function updateSiteBgPreview(url){const preview=document.getElementById("siteBgPreview");preview&&(preview.innerHTML=url?`<img src="${AdminUtils.escapeHtml(url)}" style="max-width: 100%; max-height: 300px; object-fit: cover;">`:"")}async function getHomeSections(){const sections=[],list=document.getElementById("homeSectionsList");return list?(list.querySelectorAll(".section-item").forEach(item=>{const id=item.dataset.id;if(id){const imageInput=item.querySelector('[data-field="image"]'),image=imageInput?.value||"",title=item.querySelector('[data-field="title"]')?.value||"",description=item.querySelector('[data-field="description"]')?.value||"";sections.push({id:parseInt(id),image:image,title:title,description:description})}}),sections):sections}function renderHomeSections(sections){const list=document.getElementById("homeSectionsList");list&&(list.innerHTML=sections.map(s=>{const imagePreviewId=`sectionImagePreview_${s.id}`,imageUrlInputId=(s.id,`sectionImageUrl_${s.id}`),imageFileInputId=`sectionImageFile_${s.id}`;return`\n    <div class="section-item" data-id="${s.id}">\n      <div class="section-item-content">\n        <div class="section-fields">\n          <input type="text" class="section-input" data-field="title" value="${AdminUtils.escapeHtml(s.title)}" placeholder="Titre">\n          <textarea class="section-textarea" data-field="description" placeholder="Description" rows="3">${AdminUtils.escapeHtml(s.description)}</textarea>\n          <div class="section-image-group">\n            <div class="media-upload-section">\n              <div class="media-preview" id="${imagePreviewId}">\n                ${s.image?`<img src="${AdminUtils.escapeHtml(s.image)}" alt="Preview" style="max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px;">`:""}\n              </div>\n              <div class="upload-options">\n                <input type="file" id="${imageFileInputId}" accept="image/*" style="display:none">\n                <button type="button" class="btn-secondary section-upload-btn" data-section-id="${s.id}" data-file-input="${imageFileInputId}" data-url-input="${imageUrlInputId}" data-preview="${imagePreviewId}">\n                  <i class="material-icons">photo_library</i>\n                  <span>Galerie</span>\n                </button>\n                <input type="url" class="section-url-input" id="${imageUrlInputId}" data-field="image" value="${AdminUtils.escapeHtml(s.image)}" placeholder="ou URL directe">\n                <button type="button" class="btn-secondary section-url-btn" data-section-id="${s.id}" data-url-input="${imageUrlInputId}" data-preview="${imagePreviewId}">\n                  <i class="material-icons">link</i>\n                  <span>Valider</span>\n                </button>\n                <button type="button" class="btn-danger section-remove-btn" data-section-id="${s.id}" data-url-input="${imageUrlInputId}" data-preview="${imagePreviewId}">\n                  <i class="material-icons">delete</i>\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n        <div class="section-item-actions">\n          <button class="btn-secondary section-move-btn" onclick="moveSection(${s.id}, 'up')" title="D√©placer vers le haut">\n            <i class="material-icons">arrow_upward</i>\n          </button>\n          <button class="btn-secondary section-move-btn" onclick="moveSection(${s.id}, 'down')" title="D√©placer vers le bas">\n            <i class="material-icons">arrow_downward</i>\n          </button>\n          <button class="btn-danger" onclick="deleteSection(${s.id})" title="Supprimer">\n            <i class="material-icons">delete</i>\n            <span>Supprimer</span>\n          </button>\n        </div>\n      </div>\n    </div>\n  `}).join(""),setupSectionImageUploads())}async function addHomeSection(){if(addHomeSection._isSaving||window._creatingSection)return void console.log("‚ö†Ô∏è Cr√©ation de section d√©j√† en cours...");const now=Date.now();if(addHomeSection._lastCreation&&now-addHomeSection._lastCreation<1e3)console.log("‚ö†Ô∏è Attendez un peu avant de cr√©er une nouvelle section");else{addHomeSection._isSaving=!0,window._creatingSection=!0,addHomeSection._lastCreation=now;try{const sections=await getHomeSections(),beforeCount=sections.length;if(sections.push({id:Date.now(),image:"",title:"",description:""}),renderHomeSections(sections),await saveConfig(),(await getHomeSections()).length!==beforeCount+1){console.warn("‚ö†Ô∏è Plusieurs sections cr√©√©es, correction...");const correctedSections=await getHomeSections();correctedSections.length>beforeCount+1&&(correctedSections.splice(beforeCount+1),renderHomeSections(correctedSections),await saveConfig())}AdminUtils.showToast("Section ajout√©e","success")}catch(error){console.error("Erreur cr√©ation section:",error),AdminUtils.showToast("Erreur lors de la cr√©ation","error")}finally{setTimeout(()=>{addHomeSection._isSaving=!1,window._creatingSection=!1},1e3)}}}async function moveSection(id,direction){const sections=await getHomeSections(),index=sections.findIndex(s=>s.id===id);index<0||("up"===direction&&index>0?[sections[index-1],sections[index]]=[sections[index],sections[index-1]]:"down"===direction&&index<sections.length-1&&([sections[index],sections[index+1]]=[sections[index+1],sections[index]]),renderHomeSections(sections),await saveConfig())}async function deleteSection(id){AdminUtils.confirmAction("Supprimer cette section?")&&(renderHomeSections((await getHomeSections()).filter(s=>s.id!==id)),await saveConfig())}async function checkBackendStatus(){const status=document.getElementById("backendStatus");if(status)if(getBackendUrl())try{const result=await backendAPI.testConnection();status.innerHTML=`\n      <span class="status-indicator ${result.connected?"active":""}" style="${result.connected?"background: #10b981;":"background: #ef4444;"}"></span>\n      <span class="status-text">${result.message}</span>\n    `}catch(error){status.innerHTML='\n      <span class="status-indicator" style="background: #10b981;"></span>\n      <span class="status-text">Mode localStorage (fallback automatique)</span>\n    '}else status.innerHTML='\n      <span class="status-indicator active" style="background: #10b981;"></span>\n      <span class="status-text">Mode localStorage (pas de backend requis)</span>\n    '}function setupSectionImageUploads(){document.querySelectorAll(".section-upload-btn").forEach(btn=>{btn.onclick=null,btn.addEventListener("click",async e=>{const fileInputId=btn.dataset.fileInput,urlInputId=btn.dataset.urlInput,previewId=btn.dataset.preview,fileInput=document.getElementById(fileInputId);fileInput&&(fileInput.click(),fileInput.onchange=async changeEvent=>{const file=changeEvent.target.files[0];if(file)try{const preview=document.getElementById(previewId);preview&&(preview.innerHTML='<div style="text-align: center; padding: 1rem; color: var(--text-secondary);">Chargement...</div>');const fileSize=file.size,sizeMB=(fileSize/1048576).toFixed(2),hasBackend=backendAPI.baseUrl&&""!==backendAPI.baseUrl.trim();let mediaUrl;if(hasBackend){console.log("üì§ Upload vers Vercel Blob...");const uploadResult=await backendAPI.uploadFile(file,"config");if(!uploadResult.success||!uploadResult.url)throw new Error("√âchec de l'upload");mediaUrl=uploadResult.url,console.log(`‚úÖ Upload r√©ussi: ${mediaUrl}`),AdminUtils.showToast(`‚úÖ Fichier upload√© vers le cloud (${sizeMB}MB)`,"success")}else{if(fileSize>2097152){const message=`‚ö†Ô∏è Fichier trop volumineux (${sizeMB}MB). Les fichiers de plus de 2MB n√©cessitent un backend configur√© avec Vercel Blob.`;return AdminUtils.showToast(message,"error"),preview&&(preview.innerHTML=`\n                    <div style="padding: 2rem; text-align: center; color: #ff6b6b;">\n                      <p style="font-weight: bold; margin-bottom: 1rem;">‚ùå Fichier trop volumineux pour localStorage</p>\n                      <p style="font-size: 0.9rem; margin-bottom: 1rem;">Taille: ${sizeMB}MB (limite: 2MB)</p>\n                      <p style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-top: 1rem;">üí° Configurez le backend dans les param√®tres.</p>\n                    </div>\n                  `),void(changeEvent.target.value="")}console.log("üì¶ Conversion en DataURL pour localStorage..."),mediaUrl=await AdminUtils.readFileAsDataURL(file)}const urlInput=document.getElementById(urlInputId);urlInput&&(urlInput.value=mediaUrl),preview&&(preview.innerHTML=`<img src="${mediaUrl}" alt="Preview" style="max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px;">`),await saveConfig(),hasBackend||AdminUtils.showToast("Image ajout√©e avec succ√®s","success")}catch(error){console.error("Erreur upload image:",error),AdminUtils.showToast("Erreur lors de l'upload","error")}})})}),document.querySelectorAll(".section-url-btn").forEach(btn=>{btn.onclick=null,btn.addEventListener("click",async e=>{const urlInputId=btn.dataset.urlInput,previewId=btn.dataset.preview,urlInput=document.getElementById(urlInputId);if(urlInput){const url=urlInput.value.trim();if(url&&AdminUtils.isValidUrl(url)||url.startsWith("data:")){const preview=document.getElementById(previewId);preview&&(preview.innerHTML=`<img src="${url}" alt="Preview" style="max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px;" onerror="this.parentElement.innerHTML='<div style=\\'color: var(--error); padding: 0.5rem;\\'>Image invalide</div>'">`),await saveConfig(),AdminUtils.showToast("URL valid√©e","success")}else AdminUtils.showToast("URL invalide","error")}})}),document.querySelectorAll(".section-remove-btn").forEach(btn=>{btn.onclick=null,btn.addEventListener("click",async e=>{const urlInputId=btn.dataset.urlInput,previewId=btn.dataset.preview,urlInput=document.getElementById(urlInputId);if(urlInput){urlInput.value="";const preview=document.getElementById(previewId);preview&&(preview.innerHTML=""),await saveConfig(),AdminUtils.showToast("Image supprim√©e","success")}})}),document.querySelectorAll(".section-url-input").forEach(input=>{input.addEventListener("paste",async e=>{setTimeout(async()=>{const url=input.value.trim();if(url&&(AdminUtils.isValidUrl(url)||url.startsWith("data:"))){const sectionId=input.closest(".section-item")?.dataset.id;if(sectionId){const preview=document.getElementById(`sectionImagePreview_${sectionId}`);preview&&(preview.innerHTML=`<img src="${url}" alt="Preview" style="max-width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px;" onerror="this.parentElement.innerHTML=''">`),await saveConfig()}}},100)})})}function setupServicesButtonsUI(){const addServiceBtn=document.getElementById("addServiceButtonBtn");if(!addServiceBtn)return void console.warn("‚ö†Ô∏è Bouton addServiceButtonBtn non trouv√©");window._creatingService=!1;const newBtn=addServiceBtn.cloneNode(!0);addServiceBtn.replaceWith(newBtn),newBtn.onclick=async function(e){if(e.preventDefault(),e.stopPropagation(),console.log("üîò Clic sur ajouter bouton service"),console.log("√âtat actuel:",{disabled:newBtn.disabled,creatingService:window._creatingService}),newBtn.disabled)return console.log("‚ö†Ô∏è Bouton d√©sactiv√©"),!1;window._creatingService&&(console.log("‚ö†Ô∏è Cr√©ation d√©j√† en cours, r√©initialisation..."),window._creatingService=!1),window._creatingService=!0,newBtn.disabled=!0;const originalHTML=newBtn.innerHTML;newBtn.innerHTML='<i class="material-icons">hourglass_empty</i> Cr√©ation...';try{console.log("üöÄ Appel de addServiceButton()"),await addServiceButton(),console.log("‚úÖ addServiceButton() termin√©")}catch(error){console.error("‚ùå Erreur cr√©ation bouton service:",error),AdminUtils.showToast("Erreur lors de la cr√©ation","error"),window._creatingService=!1}finally{setTimeout(()=>{window._creatingService=!1,newBtn.disabled=!1,newBtn.innerHTML=originalHTML,console.log("‚úÖ Bouton r√©initialis√©")},1e3)}return!1},console.log("‚úÖ Bouton ajouter services configur√©"),setTimeout(()=>{const testBtn=document.getElementById("addServiceButtonBtn");testBtn&&testBtn.onclick?console.log("‚úÖ Bouton correctement attach√© avec onclick"):console.error("‚ùå Bouton non attach√© correctement")},100)}async function getServicesButtons(){const buttons=[],list=document.getElementById("servicesButtonsList");return list?(list.querySelectorAll(".service-button-item").forEach(item=>{const id=item.dataset.id;if(id){const iconInput=item.querySelector('[data-field="icon"]'),titleInput=item.querySelector('[data-field="title"]'),textInput=item.querySelector('[data-field="text"]');buttons.push({id:parseInt(id),icon:iconInput?.value||"üåø",title:titleInput?.value||"SERVICES",text:textInput?.value||""})}}),buttons):buttons}function renderServicesButtons(buttons){const list=document.getElementById("servicesButtonsList");list&&(list.innerHTML=buttons.map(b=>`\n    <div class="service-button-item" data-id="${b.id}">\n      <div class="service-button-content">\n        <div class="service-button-fields">\n          <div class="input-group">\n            <label>Ic√¥ne / Emoji</label>\n            <input type="text" class="section-input" data-field="icon" value="${AdminUtils.escapeHtml(b.icon)}" placeholder="üåø">\n            <small style="color: var(--text-muted);">Emoji ou texte court</small>\n          </div>\n          <div class="input-group">\n            <label>Titre</label>\n            <input type="text" class="section-input" data-field="title" value="${AdminUtils.escapeHtml(b.title)}" placeholder="SERVICES">\n          </div>\n          <div class="input-group">\n            <label>Texte (supporte emojis et retours √† la ligne)</label>\n            <textarea class="section-textarea" data-field="text" placeholder="Description des services..." rows="5">${AdminUtils.escapeHtml(b.text)}</textarea>\n          </div>\n        </div>\n        <div class="section-item-actions">\n          <button class="btn-secondary section-move-btn" onclick="moveServiceButton(${b.id}, 'up')" title="D√©placer vers le haut">\n            <i class="material-icons">arrow_upward</i>\n          </button>\n          <button class="btn-secondary section-move-btn" onclick="moveServiceButton(${b.id}, 'down')" title="D√©placer vers le bas">\n            <i class="material-icons">arrow_downward</i>\n          </button>\n          <button class="btn-danger" onclick="deleteServiceButton(${b.id})" title="Supprimer">\n            <i class="material-icons">delete</i>\n            <span>Supprimer</span>\n          </button>\n        </div>\n      </div>\n    </div>\n  `).join(""))}async function addServiceButton(){console.log("üìù addServiceButton() appel√©e");const now=Date.now();if(addServiceButton._lastCreation&&now-addServiceButton._lastCreation<500)console.log("‚ö†Ô∏è Attendez un peu avant de cr√©er un nouveau bouton");else{addServiceButton._lastCreation=now;try{console.log("üìã R√©cup√©ration des boutons existants...");const buttons=await getServicesButtons(),beforeCount=buttons.length;console.log(`üìä Boutons existants: ${beforeCount}`);const newButton={id:Date.now(),icon:"üåø",title:"SERVICES",text:""};buttons.push(newButton),console.log("‚úÖ Nouveau bouton ajout√© au tableau:",newButton),console.log("üé® Rendu des boutons..."),renderServicesButtons(buttons),console.log("üíæ Sauvegarde de la configuration..."),await saveConfig();const afterCount=(await getServicesButtons()).length;if(console.log(`üìä Boutons apr√®s cr√©ation: ${afterCount}`),afterCount!==beforeCount+1){console.warn("‚ö†Ô∏è Plusieurs boutons cr√©√©s, correction...");const correctedButtons=await getServicesButtons();correctedButtons.length>beforeCount+1&&(correctedButtons.splice(beforeCount+1),renderServicesButtons(correctedButtons),await saveConfig())}AdminUtils.showToast("Bouton service ajout√©","success"),console.log("‚úÖ Bouton service cr√©√© avec succ√®s")}catch(error){throw console.error("‚ùå Erreur cr√©ation bouton service:",error),console.error("Stack:",error.stack),AdminUtils.showToast("Erreur lors de la cr√©ation: "+error.message,"error"),error}}}async function moveServiceButton(id,direction){const buttons=await getServicesButtons(),index=buttons.findIndex(b=>b.id===id);index<0||("up"===direction&&index>0?[buttons[index-1],buttons[index]]=[buttons[index],buttons[index-1]]:"down"===direction&&index<buttons.length-1&&([buttons[index],buttons[index+1]]=[buttons[index+1],buttons[index]]),renderServicesButtons(buttons),await saveConfig())}async function deleteServiceButton(id){AdminUtils.confirmAction("Supprimer ce bouton service?")&&(renderServicesButtons((await getServicesButtons()).filter(b=>b.id!==id)),await saveConfig(),AdminUtils.showToast("Bouton supprim√©","success"))}window.moveServiceButton=moveServiceButton,window.deleteServiceButton=deleteServiceButton,window.Config={initConfig:initConfig};