const BLOB_RW_TOKEN="vercel_blob_rw_dNrLIshPfgSxTWVp_wQnU1eWFuWULWe9a25nMn5yun31RzE",BLOB_BASE_URL="https://blob.vercel-storage.com";class BackendAPI{constructor(){this.baseUrl=localStorage.getItem("backendUrl")||"",this.apiKey="default"}setBaseUrl(url){this.baseUrl=url,localStorage.setItem("backendUrl",url)}async get(key){if(!this.baseUrl||""===this.baseUrl){const data=localStorage.getItem(key);return data?JSON.parse(data):null}try{const controller=new AbortController,timeoutId=setTimeout(()=>controller.abort(),2e3),apiUrl=this.baseUrl.includes("/api")?this.baseUrl:`${this.baseUrl}/api`,bust=Date.now();let response=await fetch(`${apiUrl}/db/${key}?t=${bust}`,{signal:controller.signal,cache:"no-store"});if(response.ok||(response=await fetch(`${apiUrl}/${key}?t=${bust}`,{signal:controller.signal,cache:"no-store"})),clearTimeout(timeoutId),!response.ok)throw new Error("Erreur r√©seau");return await response.json()}catch(error){"AbortError"===error.name?console.warn(`Timeout backend, utilisation du localStorage pour ${key}`):console.warn(`Backend indisponible, utilisation du localStorage pour ${key}`);const data=localStorage.getItem(key);return data?JSON.parse(data):null}}async put(key,data){const dataString=JSON.stringify(data),dataSize=new Blob([dataString]).size,hasBackend=this.baseUrl&&""!==this.baseUrl.trim();if(dataSize>4194304){const sizeMB=(dataSize/1048576).toFixed(2);if(hasBackend){console.log(`üì§ Donn√©es volumineuses (${sizeMB}MB), sauvegarde uniquement sur backend...`);try{const apiUrl=this.baseUrl.includes("/api")?this.baseUrl:`${this.baseUrl}/api`;if(!(await fetch(`${apiUrl}/db/${key}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:dataString})).ok)throw new Error("Erreur sauvegarde backend");return syncToSite(key,data),console.log(`‚úÖ Donn√©es sauvegard√©es sur backend uniquement (${sizeMB}MB)`),{success:!0,source:"backend",warning:`Donn√©es volumineuses (${sizeMB}MB) sauvegard√©es uniquement sur backend`}}catch(error){console.warn(`‚ùå √âchec sauvegarde backend pour ${key}, tentative localStorage...`,error)}}if(!hasBackend)throw new Error(`Les donn√©es sont trop volumineuses (${sizeMB}MB). Configurez un backend avec Vercel Blob pour sauvegarder des fichiers volumineux.`)}try{localStorage.setItem(key,dataString),syncToSite(key,data)}catch(error){if("QuotaExceededError"===error.name||error.message.includes("quota")||error.message.includes("exceeded")){if(console.error("‚ùå QuotaExceededError lors de la sauvegarde localStorage:",error),hasBackend){console.log("‚ö†Ô∏è localStorage plein, sauvegarde uniquement sur backend...");try{const apiUrl=this.baseUrl.includes("/api")?this.baseUrl:`${this.baseUrl}/api`;if(!(await fetch(`${apiUrl}/db/${key}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:dataString})).ok)throw new Error("Erreur sauvegarde backend");return syncToSite(key,data),{success:!0,source:"backend",warning:"localStorage plein, sauvegard√© uniquement sur backend"}}catch(backendError){console.error("‚ùå √âchec sauvegarde backend:",backendError)}}throw new Error("‚ùå Erreur: Le stockage localStorage est plein. Les donn√©es sont trop volumineuses.\n\nSolution: Utilisez un backend avec Vercel Blob pour sauvegarder des fichiers volumineux.")}throw error}if(!hasBackend)return{success:!0,source:"localStorage"};try{const apiUrl=this.baseUrl.includes("/api")?this.baseUrl:`${this.baseUrl}/api`;if(!(await fetch(`${apiUrl}/db/${key}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)})).ok)throw new Error("Erreur sauvegarde");return{success:!0,source:"backend"}}catch(error){return console.warn(`Sauvegarde backend √©chou√©e, donn√©es en localStorage pour ${key}`),{success:!0,source:"localStorage"}}}async uploadFile(file,path=""){const token=BLOB_RW_TOKEN||null;if(token){const sanitizedName=(file.name||`fichier_${Date.now()}`).replace(/[^a-zA-Z0-9._-]/g,"_"),timestamp=Date.now(),random=Math.random().toString(36).substring(2,8);let folder="uploads";path?folder=path.replace(/[^a-zA-Z0-9/_-]/g,"_"):file.type&&file.type.startsWith("video/")?folder="videos":file.type&&file.type.startsWith("image/")&&(folder="images");const finalPath=`${folder}/${timestamp}_${random}_${sanitizedName}`,uploadUrl=`${BLOB_BASE_URL}/${finalPath}`;console.log(`üì§ Upload direct vers Blob: ${uploadUrl}`);const headers={Authorization:`Bearer ${token}`};file.type&&(headers["Content-Type"]=file.type);const response=await fetch(uploadUrl,{method:"PUT",headers:headers,body:file});if(!response.ok){let details="";try{details=await response.text()}catch{}throw new Error(`Erreur upload Blob (${response.status} ${response.statusText}) ${details?"- "+details:""}`)}let resultData=null;try{resultData=await response.json()}catch{}return{success:!0,url:resultData?.url||`${uploadUrl.replace(BLOB_BASE_URL,resultData?.hostname?`https://${resultData.hostname}`:BLOB_BASE_URL)}`,pathname:resultData?.pathname||finalPath,source:"blob-direct"}}if(!this.baseUrl)return{success:!0,url:await AdminUtils.readFileAsDataURL(file),source:"dataurl"};try{let uploadPath=path;uploadPath||(uploadPath=file.type&&file.type.startsWith("video/")?"video":(file.type&&file.type.startsWith("image/"),"products"));const apiUrl=this.baseUrl.includes("/api")?this.baseUrl:`${this.baseUrl}/api`,fileName=file.name||`file_${Date.now()}`;console.log(`üì§ Upload via blob-upload: ${fileName} (${(file.size/1024/1024).toFixed(2)} MB)`);const uploadResponse=await fetch(`${apiUrl}/blob-upload`,{method:"POST",headers:{"x-vercel-blob-file-name":fileName,"x-vercel-blob-pathname":uploadPath},body:file});if(!uploadResponse.ok){const errorData=await uploadResponse.json().catch(()=>({error:"Erreur upload"}));throw console.error("‚ùå Erreur upload Blob:",uploadResponse.status,errorData),new Error(`Erreur upload Blob: ${errorData.error||uploadResponse.status}`)}const blobResult=await uploadResponse.json();if(blobResult.url)return console.log("‚úÖ Fichier upload√© vers Vercel Blob:",blobResult.url),{success:!0,url:blobResult.url,source:"blob"};throw new Error("R√©ponse invalide de l'API upload")}catch(error){console.warn("‚ö†Ô∏è Upload Blob √©chou√©, fallback base64:",error.message);try{const fileSize=file.size;if(fileSize>2097152)throw new Error(`Fichier trop volumineux (${(fileSize/1024/1024).toFixed(2)}MB) pour le fallback. Limite: 2MB.`);return{success:!0,url:await AdminUtils.readFileAsDataURL(file),source:"dataurl"}}catch(fallbackError){throw new Error(`√âchec upload et fallback: ${error.message} | ${fallbackError.message}`)}}}async testConnection(){if(!this.baseUrl||""===this.baseUrl)return{connected:!1,message:"Mode localStorage - pas de backend requis"};try{const apiUrl=this.baseUrl.includes("/api")?this.baseUrl:`${this.baseUrl}/api`,response=await fetch(`${apiUrl}/config.json`,{method:"GET",signal:AbortSignal.timeout(3e3)});return{connected:response.ok,message:response.ok?"Connect√©":"Erreur"}}catch(error){return"AbortError"===error.name?{connected:!1,message:"Timeout - backend non disponible"}:{connected:!1,message:"Non connect√©"}}}}function syncToSite(key,data){try{const siteKey={"products.json":"products",products:"products","categories.json":"categories",categories:"categories","farms.json":"farms",farms:"farms","payments.json":"payments",payments:"payments","promos.json":"promos",promos:"promos","banner.json":"banner",banner:"banner","loadingscreen.json":"loadingscreen",loadingscreen:"loadingscreen","config.json":"config",config:"config","socials.json":"socials",socials:"socials","maintenance.json":"maintenance",maintenance:"maintenance","typography.json":"typography",typography:"typography","cart_services.json":"cart_services",cart_services:"cart_services","cart_options.json":"cart_options",cart_options:"cart_options","cart_slots.json":"cart_slots",cart_slots:"cart_slots","categoriesEnabled.json":"categoriesEnabled",categoriesEnabled:"categoriesEnabled","farmsEnabled.json":"farmsEnabled",farmsEnabled:"farmsEnabled","productModal.json":"productModal",productModal:"productModal","reviews.json":"reviews",reviews:"reviews"}[key]||key.replace(".json","");localStorage.setItem(`site_${siteKey}`,JSON.stringify(data)),localStorage.setItem(`site_${siteKey}_timestamp`,Date.now().toString()),window.dispatchEvent(new CustomEvent("adminDataUpdated",{detail:{key:siteKey,data:data}})),console.log(`‚úÖ Donn√©es synchronis√©es: ${siteKey}`,data)}catch(error){console.warn("Erreur synchronisation site:",error)}}window.backendAPI=new BackendAPI;class SyncManager{constructor(){this.lastSync=new Map,this.isPolling=!1,this.pollInterval=null,this.syncListeners=new Map}onSync(key,callback){this.syncListeners.has(key)||this.syncListeners.set(key,[]),this.syncListeners.get(key).push(callback)}offSync(key,callback){const listeners=this.syncListeners.get(key);if(listeners){const index=listeners.indexOf(callback);index>-1&&listeners.splice(index,1)}}notifySync(key,data){const listeners=this.syncListeners.get(key);listeners&&listeners.forEach(callback=>{try{callback(data)}catch(error){console.error("Erreur listener sync:",error)}})}hasChanged(key,newData){const lastData=this.lastSync.get(key);return!lastData||JSON.stringify(lastData)!==JSON.stringify(newData)}startPolling(interval=5e3){this.isPolling||(this.isPolling=!0,console.log("üîÑ D√©marrage synchronisation multi-utilisateurs (polling toutes les 5s)"),this.pollInterval=setInterval(async()=>{try{const allKeys=Object.keys(DATA_FILES);for(const key of allKeys)try{const data=await backendAPI.get(DATA_FILES[key]);data&&this.hasChanged(key,data)&&(console.log(`üîî Donn√©es mises √† jour par un autre utilisateur: ${key}`),localStorage.setItem(DATA_FILES[key],JSON.stringify(data)),this.lastSync.set(key,data),this.notifySync(key,data),window.dispatchEvent(new CustomEvent("dataUpdated",{detail:{key:key,data:data}})),AdminUtils.showToast(`üì¢ Donn√©es mises √† jour: ${key}`,"info"))}catch(error){}}catch(error){console.warn("Erreur polling sync:",error)}},interval))}stopPolling(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null,this.isPolling=!1,console.log("‚èπÔ∏è Arr√™t synchronisation multi-utilisateurs"))}async init(){try{const allKeys=Object.keys(DATA_FILES);for(const key of allKeys)try{const data=await backendAPI.get(DATA_FILES[key]);data&&this.lastSync.set(key,data)}catch(error){}backendAPI.baseUrl&&""!==backendAPI.baseUrl.trim()&&this.startPolling(),console.log("‚úÖ Synchronisation multi-utilisateurs initialis√©e")}catch(error){console.error("Erreur initialisation sync:",error)}}}window.syncManager=new SyncManager;const DATA_FILES={products:"products.json",categories:"categories.json",farms:"farms.json",payments:"payments.json",promos:"promos.json",banner:"banner.json",loadingscreen:"loadingscreen.json",config:"config.json",socials:"socials.json",maintenance:"maintenance.json",typography:"typography.json",cart_services:"cart_services.json",cart_options:"cart_options.json",cart_slots:"cart_slots.json",admin_users:"admin_users.json",categoriesEnabled:"categoriesEnabled.json",farmsEnabled:"farmsEnabled.json",productModal:"productModal.json",reviews:"reviews.json",messages:"messages.json"};async function loadData(key){const data=await backendAPI.get(DATA_FILES[key]||`${key}.json`),defaultData=getDefaultData(key);return data?["products","categories","farms","payments","promos","socials","cart_options","cart_slots","admin_users","reviews","messages"].includes(key)?Array.isArray(data)?data:[]:"object"!=typeof defaultData||null===defaultData||Array.isArray(defaultData)?data:{...defaultData,...data}:defaultData}async function saveData(key,data){const result=await backendAPI.put(DATA_FILES[key]||`${key}.json`,data);return window.dispatchEvent(new CustomEvent("dataUpdated",{detail:{key:key,data:data}})),result}function getDefaultData(key){return{products:[],categories:[],farms:[],payments:[],promos:[],banner:{text:"",enabled:!1},loadingscreen:{enabled:!1,text:"Chargement...",duration:3e3,bgColor:"#0a0e1b",textColor:"#f1f5f9",accentColor:"#6366f1",animation:"spinner",background:null,logo:null},config:{shopName:"ThePlug CoffeeShop",shopTagline:"Votre meilleur caf√© √† Paris üåø",siteBackground:null,heroTitle:"",heroBrand:"ThePlug CoffeeShop",heroSubtitle:"Votre meilleur caf√© √† Paris üåø",servicesButtons:[],backendUrl:""},socials:[],maintenance:{enabled:!1,message:""},typography:{family:"Inter",size:16},cart_services:{home:!0,postal:!0,meet:!0},cart_options:[],cart_slots:[],reviews:[],messages:[],admin_users:[]}[key]||{}}window.BackendData={loadData:loadData,saveData:saveData,DATA_FILES:DATA_FILES,getDefaultData:getDefaultData};