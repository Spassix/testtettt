const ROLES={FOUNDER:"founder",MANAGER:"manager",EDITOR:"editor"},PERMISSIONS={[ROLES.FOUNDER]:["*"],[ROLES.MANAGER]:["*"],[ROLES.EDITOR]:["dashboard","products","categories","farms","banner"]};let currentUser=null;async function initAdminAccount(){const users=await BackendData.loadData("admin_users");let adminUser=users.find(u=>"admin"===u.username);if(adminUser){const needsUpdate=adminUser.role!==ROLES.FOUNDER||!0!==adminUser.protected||"admin_main"!==adminUser.id;adminUser.role=ROLES.FOUNDER,adminUser.protected=!0,adminUser.id="admin_main";const passwordNeedsUpdate=await AdminUtils.hashPassword("admin@123@123",adminUser.salt||"")!==adminUser.passwordHash;if(passwordNeedsUpdate){const newSalt=AdminUtils.generateSalt();adminUser.passwordHash=await AdminUtils.hashPassword("admin@123@123",newSalt),adminUser.salt=newSalt,console.log("✅ Mot de passe du compte admin réinitialisé")}if(needsUpdate||passwordNeedsUpdate){const adminIndex=users.findIndex(u=>"admin"===u.username);-1!==adminIndex&&(users[adminIndex]=adminUser,await BackendData.saveData("admin_users",users))}console.log("✅ Compte admin principal vérifié et protégé")}else{const salt=AdminUtils.generateSalt(),hashedPassword=await AdminUtils.hashPassword("admin@123@123",salt);adminUser={id:"admin_main",username:"admin",role:ROLES.FOUNDER,passwordHash:hashedPassword,salt:salt,createdAt:(new Date).toISOString(),protected:!0};const adminUsers=[adminUser];await BackendData.saveData("admin_users",adminUsers),console.log("✅ Compte admin principal créé (admin / admin@123@123)"),console.log("✅ Tous les autres comptes supprimés")}}async function initAuth(){await initAdminAccount();const loginForm=document.getElementById("loginForm");loginForm&&loginForm.addEventListener("submit",async e=>{e.preventDefault(),e.stopPropagation();const username=document.getElementById("loginUsername").value.trim(),password=document.getElementById("loginPassword").value,rememberMe=document.getElementById("rememberMe").checked;if(username&&password)try{await handleLogin(username,password,rememberMe)}catch(error){console.error("Erreur login:",error),AdminUtils.showToast("Erreur lors de la connexion","error")}else AdminUtils.showToast("Veuillez remplir tous les champs","error")});const loginBtn=document.querySelector('#loginForm button[type="submit"]');loginBtn&&loginBtn.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const username=document.getElementById("loginUsername").value.trim(),password=document.getElementById("loginPassword").value,rememberMe=document.getElementById("rememberMe").checked;if(username&&password)try{await handleLogin(username,password,rememberMe)}catch(error){console.error("Erreur login:",error),AdminUtils.showToast("Erreur lors de la connexion","error")}else AdminUtils.showToast("Veuillez remplir tous les champs","error")});const storedUser=localStorage.getItem("adminUser"),rememberMe="true"===localStorage.getItem("rememberMe");if(storedUser&&rememberMe)try{return currentUser=JSON.parse(storedUser),await checkAuth(),void showAdminPanel()}catch(e){console.error("Erreur restauration session",e)}showLoginScreen()}async function checkAuth(){if(!currentUser)return showLoginScreen(),!1;const user=(await BackendData.loadData("admin_users")).find(u=>u.username===currentUser.username);return user?(currentUser=user,updateUI(),!0):(logout(),!1)}function showLoginScreen(){document.getElementById("loginScreen").classList.remove("hidden"),document.getElementById("adminPanel").classList.add("hidden")}function showAdminPanel(){document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("adminPanel").classList.remove("hidden"),updateUI(),setupNavigation()}function updateUI(){if(!currentUser)return;const initials=AdminUtils.generateInitials(currentUser.username);document.getElementById("userAvatar").textContent=initials,document.getElementById("userAvatarLarge").textContent=initials,document.getElementById("userName").textContent=currentUser.username,document.getElementById("userNameLarge").textContent=currentUser.username,document.getElementById("userRoleDisplay").textContent=currentUser.role,filterMenuByRole()}function filterMenuByRole(){if(!currentUser)return;const userPerms=PERMISSIONS[currentUser.role]||[],allAccess=userPerms.includes("*");document.querySelectorAll(".menu-item, .tabbar-item").forEach(item=>{const page=item.dataset.page;if(!page)return;const hasAccess=allAccess||userPerms.includes(page);item.style.display=hasAccess?"":"none"})}async function handleLogin(username,password,rememberMe){try{const submitBtn=document.querySelector('#loginForm button[type="submit"]'),originalText=submitBtn?.textContent;submitBtn&&(submitBtn.disabled=!0,submitBtn.textContent="Connexion...");const users=await BackendData.loadData("admin_users"),user=users.find(u=>u.username===username);if(!user)return AdminUtils.showToast("Identifiants incorrects","error"),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=originalText),!1;const hashedInput=await AdminUtils.hashPassword(password,user.salt||"");if(!user.salt||user.passwordHash===password){const newSalt=AdminUtils.generateSalt(),newHash=await AdminUtils.hashPassword(password,newSalt);if(user.passwordHash=newHash,user.salt=newSalt,await BackendData.saveData("admin_users",users),hashedInput!==user.passwordHash&&await AdminUtils.hashPassword(password,user.salt)!==user.passwordHash)return AdminUtils.showToast("Identifiants incorrects","error"),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=originalText),!1}return hashedInput!==user.passwordHash?(AdminUtils.showToast("Identifiants incorrects","error"),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=originalText),!1):(currentUser=user,rememberMe&&(localStorage.setItem("adminUser",JSON.stringify(user)),localStorage.setItem("rememberMe","true")),showAdminPanel(),AdminUtils.showToast("Connexion réussie","success"),submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent=originalText),!0)}catch(error){console.error("Erreur handleLogin:",error),AdminUtils.showToast("Erreur lors de la connexion: "+error.message,"error");const submitBtn=document.querySelector('#loginForm button[type="submit"]');return submitBtn&&(submitBtn.disabled=!1,submitBtn.textContent="Se connecter"),!1}}function logout(){currentUser=null,localStorage.removeItem("adminUser"),localStorage.removeItem("rememberMe"),showLoginScreen(),AdminUtils.showToast("Déconnexion réussie","success")}function setupNavigation(){const logoutBtn=document.getElementById("logoutBtn");logoutBtn&&logoutBtn.addEventListener("click",logout)}function canModify(action){return!!currentUser&&(currentUser.role===ROLES.FOUNDER||currentUser.role===ROLES.MANAGER||currentUser.role!==ROLES.EDITOR&&("delete"!==action||currentUser.role===ROLES.FOUNDER))}window.Auth={initAuth:initAuth,checkAuth:checkAuth,logout:logout,getCurrentUser:()=>currentUser,canModify:canModify,ROLES:ROLES},document.addEventListener("DOMContentLoaded",async()=>{await initAuth()});