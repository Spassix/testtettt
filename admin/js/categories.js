let editingCategoryId=null;async function initCategories(){await loadCategories(),await loadCategoriesEnabled(),setupCategoriesUI()}async function loadCategoriesEnabled(){const enabled=!1!==await BackendData.loadData("categoriesEnabled");document.getElementById("categoriesEnabled").checked=enabled}async function loadCategories(){renderCategories(await BackendData.loadData("categories"))}function renderCategories(categories){const list=document.getElementById("categoriesList");list&&(0!==categories.length?list.innerHTML=categories.map(c=>`\n    <div class="list-item">\n      <div class="list-item-info">\n        <div class="list-item-title">${AdminUtils.escapeHtml(c.name)}</div>\n        <div class="list-item-meta">Créée le ${AdminUtils.formatDate(c.createdAt)}</div>\n      </div>\n      <div class="list-item-actions">\n        <button class="btn-secondary" onclick="editCategory(${c.id})">Modifier</button>\n        <button class="btn-danger" onclick="deleteCategory(${c.id})">Supprimer</button>\n      </div>\n    </div>\n  `).join(""):list.innerHTML='<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucune catégorie</div>')}function setupCategoriesUI(){const addBtn=document.getElementById("addCategoryBtn");addBtn&&addBtn.addEventListener("click",()=>{openCategoryModal()});const enabledToggle=document.getElementById("categoriesEnabled");enabledToggle&&enabledToggle.addEventListener("change",async e=>{const enabled=e.target.checked;await BackendData.saveData("categoriesEnabled",enabled),localStorage.setItem("site_categoriesEnabled",JSON.stringify(enabled)),window.dispatchEvent(new CustomEvent("adminDataUpdated",{detail:{key:"categoriesEnabled",data:enabled}})),AdminUtils.showToast(enabled?"Catégories activées":"Catégories désactivées","success")}),modalManager.setupModal("categoryModal",saveCategory,()=>{editingCategoryId=null,resetForm("categoryForm")})}function openCategoryModal(category=null){editingCategoryId=category?.id||null,document.getElementById("categoryModal");const title=document.getElementById("categoryModalTitle"),nameInput=document.getElementById("categoryName");category?(title.textContent="Modifier la catégorie",nameInput.value=category.name||"",nameInput.setAttribute("data-editing-id",category.id)):(title.textContent="Ajouter une catégorie",nameInput.value="",nameInput.removeAttribute("data-editing-id")),modalManager.open("categoryModal")}async function saveCategory(){const nameInput=document.getElementById("categoryName"),name=nameInput.value.trim();if(!name)return AdminUtils.showToast("Le nom est requis","error"),nameInput.focus(),!1;const categories=await BackendData.loadData("categories");if(editingCategoryId){const category=categories.find(c=>c.id===editingCategoryId);category&&(category.name=name,await BackendData.saveData("categories",categories),AdminUtils.showToast("Catégorie modifiée","success"))}else{if(categories.find(c=>c.name.toLowerCase()===name.toLowerCase()))return AdminUtils.showToast("Cette catégorie existe déjà","error"),nameInput.focus(),!1;categories.push({id:Date.now(),name:name,createdAt:(new Date).toISOString()}),await BackendData.saveData("categories",categories),AdminUtils.showToast("Catégorie ajoutée","success")}return await loadCategories(),editingCategoryId=null,resetForm("categoryForm"),!0}async function editCategory(id){const category=(await BackendData.loadData("categories")).find(c=>c.id===id);category&&openCategoryModal(category)}async function deleteCategory(id){if(!AdminUtils.confirmAction("Supprimer cette catégorie?"))return;const filtered=(await BackendData.loadData("categories")).filter(c=>c.id!==id);await BackendData.saveData("categories",filtered),await loadCategories(),AdminUtils.showToast("Catégorie supprimée","success")}window.editCategory=editCategory,window.deleteCategory=deleteCategory,window.Categories={initCategories:initCategories};