let currentPage="dashboard";async function initAdmin(){const existingOverlay=document.getElementById("sidebarOverlay");existingOverlay&&existingOverlay.remove(),setupNavigation(),setupMobileNavigation(),setupTopbarMenus(),setTimeout(async()=>{if(window.syncManager&&window.backendAPI)try{const backendUrl=backendAPI.baseUrl||window.location.origin;backendAPI.baseUrl||backendAPI.setBaseUrl(backendUrl),await syncManager.init()}catch(error){console.error("Erreur initialisation sync:",error)}},500),showPage("dashboard")}function setupNavigation(){document.querySelectorAll(".menu-item, .tabbar-item").forEach(item=>{item.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const page=item.dataset.page;if(page){console.log("ðŸ“„ Navigation vers:",page);const sidebar=document.getElementById("sidebar");sidebar&&(sidebar.classList.remove("open"),document.body.style.overflow="");const overlay=document.getElementById("sidebarOverlay");overlay&&overlay.remove(),showPage(page)}})});const sidebar=document.getElementById("sidebar");if(sidebar){sidebar.addEventListener("wheel",e=>{const sidebarElement=e.currentTarget;if(sidebarElement.classList.contains("open")){const isScrollable=sidebarElement.scrollHeight>sidebarElement.clientHeight,isAtTop=0===sidebarElement.scrollTop,isAtBottom=sidebarElement.scrollTop+sidebarElement.clientHeight>=sidebarElement.scrollHeight;!isScrollable||isAtTop&&e.deltaY<0||isAtBottom&&e.deltaY>0?isAtTop&&e.deltaY<0?(e.preventDefault(),e.stopPropagation()):(isAtBottom&&e.deltaY,e.preventDefault(),e.stopPropagation()):e.stopPropagation()}},{passive:!1});let touchStartY=0;sidebar.addEventListener("touchstart",e=>{touchStartY=e.touches[0].clientY},{passive:!0}),sidebar.addEventListener("touchmove",e=>{const sidebarElement=e.currentTarget;sidebarElement.classList.contains("open")&&(e.touches[0].clientY,sidebarElement.scrollHeight,sidebarElement.clientHeight,sidebarElement.scrollTop,sidebarElement.scrollTop,sidebarElement.clientHeight,sidebarElement.scrollHeight,e.stopPropagation())},{passive:!1}),sidebar.addEventListener("click",e=>{e.stopPropagation()})}function handleSidebarToggle(e){e.preventDefault(),e.stopPropagation(),console.log("ðŸ”˜ Bouton sidebar cliquÃ©");const sidebar=document.getElementById("sidebar");if(!sidebar)return console.warn("Sidebar non trouvÃ©"),!1;if(sidebar.classList.contains("open")){sidebar.classList.remove("open"),document.body.style.overflow="";const overlay=document.getElementById("sidebarOverlay");overlay&&overlay.remove()}else{sidebar.classList.add("open"),document.body.style.overflow="hidden";const existingOverlay=document.getElementById("sidebarOverlay");existingOverlay&&existingOverlay.remove()}return!1}function removeSidebarOverlay(){const overlay=document.getElementById("sidebarOverlay");overlay&&overlay.remove()}!function(){const sidebarToggle=document.getElementById("sidebarToggle");if(!sidebarToggle)return void console.warn("sidebarToggle non trouvÃ©");const newToggle=sidebarToggle.cloneNode(!0);sidebarToggle.parentNode.replaceChild(newToggle,sidebarToggle);const toggleBtn=document.getElementById("sidebarToggle");toggleBtn&&(toggleBtn.addEventListener("click",handleSidebarToggle),toggleBtn.addEventListener("touchstart",e=>{e.preventDefault(),handleSidebarToggle(e)},{passive:!1}))}(),setInterval(removeSidebarOverlay,1e3),document.body.addEventListener("wheel",e=>{const sidebar=document.getElementById("sidebar");if(sidebar&&sidebar.classList.contains("open")){if(removeSidebarOverlay(),sidebar.contains(e.target)||sidebar===e.target)return;e.preventDefault()}},{passive:!1}),document.body.addEventListener("touchmove",e=>{const sidebar=document.getElementById("sidebar");if(sidebar&&sidebar.classList.contains("open")){if(removeSidebarOverlay(),sidebar.contains(e.target)||sidebar===e.target)return;e.preventDefault()}},{passive:!1}),document.addEventListener("click",e=>{const sidebar=document.getElementById("sidebar");if(!sidebar||!sidebar.classList.contains("open"))return;const toggle=document.getElementById("sidebarToggle");if(sidebar.contains(e.target))return;if(toggle&&toggle.contains(e.target))return;sidebar.classList.remove("open"),document.body.style.overflow="";const overlay=document.getElementById("sidebarOverlay");overlay&&overlay.remove()});const searchInput=document.getElementById("topbarSearch");searchInput&&searchInput.addEventListener("input",AdminUtils.debounce(e=>{handleSearch(e.target.value)},300));const overlay=document.getElementById("modalOverlay");overlay&&overlay.addEventListener("click",e=>{e.target===overlay&&closeAllModals()})}function setupMobileNavigation(){document.getElementById("mobileTabbar")&&document.querySelectorAll(".tabbar-item").forEach(item=>{item.addEventListener("click",()=>{document.querySelectorAll(".tabbar-item").forEach(i=>i.classList.remove("active")),item.classList.add("active")})})}function setupTopbarMenus(){const notifBtn=document.getElementById("notificationsBtn"),notifPanel=document.getElementById("notificationsPanel"),userMenu=document.getElementById("userMenu"),userDropdown=document.getElementById("userDropdown"),logoutBtn=document.getElementById("logoutBtn");if(notifBtn){const nb=notifBtn.cloneNode(!0);notifBtn.parentNode.replaceChild(nb,notifBtn),nb.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),notifPanel&&notifPanel.classList.toggle("hidden")})}if(userMenu){const um=userMenu.cloneNode(!0);userMenu.parentNode.replaceChild(um,userMenu),um.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),userDropdown&&userDropdown.classList.toggle("hidden")})}if(logoutBtn){const lb=logoutBtn.cloneNode(!0);logoutBtn.parentNode.replaceChild(lb,logoutBtn);const newLogoutBtn=document.getElementById("logoutBtn");newLogoutBtn&&newLogoutBtn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),window.Auth&&window.Auth.logout&&window.Auth.logout()})}document.addEventListener("click",e=>{if(notifPanel&&!notifPanel.contains(e.target)){const nb=document.getElementById("notificationsBtn");nb&&nb.contains(e.target)||notifPanel.classList.add("hidden")}if(userDropdown&&!userDropdown.contains(e.target)){const um2=document.getElementById("userMenu");um2&&um2.contains(e.target)||userDropdown.classList.add("hidden")}})}async function showPage(pageName){document.querySelectorAll(".page").forEach(p=>{p.classList.add("hidden")});const pageElement=document.getElementById(`page-${pageName}`);if(pageElement){pageElement.classList.remove("hidden"),currentPage=pageName,document.querySelectorAll(".menu-item, .tabbar-item").forEach(item=>{item.classList.toggle("active",item.dataset.page===pageName)}),await initPageModule(pageName);const sidebar=document.getElementById("sidebar");if(sidebar){sidebar.classList.remove("open"),document.body.style.overflow="";const overlay=document.getElementById("sidebarOverlay");overlay&&overlay.remove()}}}async function initPageModule(pageName){const initFn={dashboard:window.Dashboard?.initDashboard,products:window.Products?.initProducts,"cart-config":window.CartConfig?.initCartConfig,promos:window.Promos?.initPromos,banner:window.Banner?.initBanner,loading:window.Loading?.initLoading,categories:window.Categories?.initCategories,farms:window.Farms?.initFarms,socials:window.Socials?.initSocials,typography:window.Typography?.initTypography,"product-modal":window.ProductModal?.initProductModal,users:window.Users?.initUsers,maintenance:window.Maintenance?.initMaintenance,config:window.Config?.initConfig,reviews:window.Reviews?.initReviews,messages:window.Messages?.initMessages}[pageName];if(initFn)try{await initFn()}catch(error){console.error(`Erreur initialisation ${pageName}:`,error),AdminUtils.showToast(`Erreur chargement ${pageName}`,"error")}}function handleSearch(query){query.trim()&&console.log("Recherche:",query)}function closeAllModals(){document.querySelectorAll(".modal").forEach(m=>m.classList.add("hidden")),document.getElementById("modalOverlay")?.classList.add("hidden")}document.addEventListener("DOMContentLoaded",async()=>{await new Promise(resolve=>setTimeout(resolve,100));const currentUser=Auth?.getCurrentUser();currentUser&&await initAdmin()}),window.AdminPanel={showPage:showPage,initAdmin:initAdmin};