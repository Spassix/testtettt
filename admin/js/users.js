let editingUserId=null;async function initUsers(){await loadUsers(),setupUsersUI()}async function loadUsers(){renderUsers(await BackendData.loadData("admin_users"))}function renderUsers(users){const list=document.getElementById("usersList");list&&(0!==users.length?list.innerHTML=users.map(u=>{const isProtected="admin"===u.username||!0===u.protected||"founder"===u.role;return`\n    <div class="list-item">\n      <div class="list-item-info">\n        <div class="list-item-title">${AdminUtils.escapeHtml(u.username)} ${isProtected?"ðŸ”’":""}</div>\n        <div class="list-item-meta">${u.role} - CrÃ©Ã© le ${AdminUtils.formatDate(u.createdAt)}</div>\n      </div>\n      <div class="list-item-actions">\n        ${isProtected?'<span style="color: var(--text-muted); font-size: 0.85rem;">Compte protÃ©gÃ© (non modifiable)</span>':`<button class="btn-secondary" onclick="editUser(${u.id||"temp"})">Modifier</button>`}\n        ${isProtected?'<span style="color: var(--text-muted); font-size: 0.85rem;">â€”</span>':`<button class="btn-danger" onclick="deleteUser(${u.id||"temp"})">Supprimer</button>`}\n      </div>\n    </div>\n    `}).join(""):list.innerHTML='<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucun utilisateur</div>')}function setupUsersUI(){const addBtn=document.getElementById("addUserBtn"),currentUser=Auth?.getCurrentUser();addBtn&&currentUser?"editor"===currentUser.role?addBtn.style.display="none":addBtn.addEventListener("click",()=>{openUserModal()}):addBtn&&addBtn.addEventListener("click",()=>{openUserModal()}),modalManager.setupModal("userModal",saveUser,()=>{editingUserId=null,resetForm("userForm"),document.getElementById("userConfirmPasswordGroup").style.display="none",document.getElementById("userPassword").required=!0});const passwordInput=document.getElementById("userPassword");passwordInput&&passwordInput.addEventListener("input",()=>{const confirmGroup=document.getElementById("userConfirmPasswordGroup");!editingUserId&&passwordInput.value.length>0?(confirmGroup.style.display="block",document.getElementById("userPasswordConfirm").required=!0):(confirmGroup.style.display="none",document.getElementById("userPasswordConfirm").required=!1)});const roleSelect=document.getElementById("userRole");roleSelect&&roleSelect.addEventListener("change",()=>{const currentUser=Auth?.getCurrentUser();if(currentUser&&"editor"===currentUser.role)return AdminUtils.showToast("Les Ã©diteurs ne peuvent pas crÃ©er ou modifier des comptes","error"),void(roleSelect.value="");currentUser&&"founder"!==currentUser.role&&"founder"===roleSelect.value&&(AdminUtils.showToast("Seuls les founders peuvent crÃ©er des founders","error"),roleSelect.value="")})}function openUserModal(user=null){const currentUser=Auth?.getCurrentUser();if(user&&("admin"===user.username||!0===user.protected)&&currentUser?.role!==Auth?.ROLES.FOUNDER)return void AdminUtils.showToast("Ce compte est protÃ©gÃ© et ne peut pas Ãªtre modifiÃ©","error");if(currentUser&&"editor"===currentUser.role)return void AdminUtils.showToast("Les Ã©diteurs ne peuvent pas crÃ©er ou modifier des comptes","error");editingUserId=user?.id||null,document.getElementById("userModal");const title=document.getElementById("userModalTitle"),usernameInput=document.getElementById("userUsername"),roleSelect=document.getElementById("userRole"),passwordInput=document.getElementById("userPassword"),passwordLabel=document.getElementById("userPasswordLabel"),confirmGroup=document.getElementById("userConfirmPasswordGroup");user?(title.textContent="Modifier l'utilisateur",usernameInput.value=user.username||"",roleSelect.value=user.role||"",passwordInput.value="",passwordInput.required=!1,passwordLabel.textContent="Nouveau mot de passe (laisser vide pour ne pas changer)",confirmGroup.style.display="none",usernameInput.setAttribute("data-editing-id",user.id)):(title.textContent="Ajouter un utilisateur",usernameInput.value="",roleSelect.value="",passwordInput.value="",passwordInput.required=!0,passwordLabel.textContent="Mot de passe *",confirmGroup.style.display="none",usernameInput.removeAttribute("data-editing-id")),modalManager.open("userModal")}async function saveUser(){const currentUser=Auth?.getCurrentUser();if(currentUser&&"editor"===currentUser.role)return AdminUtils.showToast("Les Ã©diteurs ne peuvent pas crÃ©er ou modifier des comptes","error"),!1;const usernameInput=document.getElementById("userUsername"),roleSelect=document.getElementById("userRole"),passwordInput=document.getElementById("userPassword"),passwordConfirmInput=document.getElementById("userPasswordConfirm"),username=usernameInput.value.trim(),role=roleSelect.value,password=passwordInput.value,usernameError=AdminUtils.validateUsername(username);if(usernameError)return AdminUtils.showToast(usernameError,"error"),usernameInput.focus(),!1;if(!role)return AdminUtils.showToast("Le rÃ´le est requis","error"),roleSelect.focus(),!1;const users=await BackendData.loadData("admin_users");if(editingUserId){const user=users.find(u=>u.id===editingUserId||u.username===username&&!u.id);if(!user)return AdminUtils.showToast("Utilisateur introuvable","error"),!1;const currentUser=Auth?.getCurrentUser();if(("admin"===user.username||!0===user.protected)&&currentUser?.role!==Auth?.ROLES.FOUNDER)return AdminUtils.showToast("Ce compte est protÃ©gÃ© et ne peut pas Ãªtre modifiÃ©","error"),!1;if("founder"===user.role&&"founder"!==role)return AdminUtils.showToast("Impossible de modifier le rÃ´le d'un fondateur","error"),roleSelect.value=user.role,!1;if(username!==user.username&&users.find(u=>u.username===username))return AdminUtils.showToast("Nom d'utilisateur dÃ©jÃ  utilisÃ©","error"),usernameInput.focus(),!1;if(user.username=username,user.role=role,password){const passwordError=AdminUtils.validatePassword(password);if(passwordError)return AdminUtils.showToast(passwordError,"error"),passwordInput.focus(),!1;user.salt=AdminUtils.generateSalt(),user.passwordHash=await AdminUtils.hashPassword(password,user.salt)}await BackendData.saveData("admin_users",users),AdminUtils.showToast("Utilisateur modifiÃ©","success")}else{if(users.find(u=>u.username===username))return AdminUtils.showToast("Nom d'utilisateur dÃ©jÃ  utilisÃ©","error"),usernameInput.focus(),!1;if(!password)return AdminUtils.showToast("Le mot de passe est requis","error"),passwordInput.focus(),!1;if(password!==passwordConfirmInput.value)return AdminUtils.showToast("Les mots de passe ne correspondent pas","error"),passwordConfirmInput.focus(),!1;const passwordError=AdminUtils.validatePassword(password);if(passwordError)return AdminUtils.showToast(passwordError,"error"),passwordInput.focus(),!1;const salt=AdminUtils.generateSalt(),passwordHash=await AdminUtils.hashPassword(password,salt);users.push({id:Date.now(),username:username,role:role,passwordHash:passwordHash,salt:salt,createdAt:(new Date).toISOString()}),await BackendData.saveData("admin_users",users),AdminUtils.showToast("Utilisateur ajoutÃ©","success")}return await loadUsers(),editingUserId=null,resetForm("userForm"),confirmGroup.style.display="none",!0}async function editUser(id){const user=(await BackendData.loadData("admin_users")).find(u=>u.id===id||!u.id&&u.username);user&&openUserModal(user)}async function deleteUser(id){const currentUser=Auth?.getCurrentUser();if(currentUser&&"editor"===currentUser.role)return void AdminUtils.showToast("Les Ã©diteurs ne peuvent pas supprimer des comptes","error");const users=await BackendData.loadData("admin_users"),user=users.find(u=>u.id===id||!u.id&&u.username);if(!user)return;if(("admin"===user.username||!0===user.protected)&&currentUser?.role!==Auth?.ROLES.FOUNDER)return void AdminUtils.showToast("Ce compte est protÃ©gÃ© et ne peut pas Ãªtre supprimÃ©","error");if("founder"===user.role)return void AdminUtils.showToast("Impossible de supprimer un fondateur","error");if(!AdminUtils.confirmAction("Supprimer cet utilisateur?"))return;const filtered=users.filter(u=>u.id!==id&&u.username!==user.username);await BackendData.saveData("admin_users",filtered),await loadUsers(),AdminUtils.showToast("Utilisateur supprimÃ©","success")}window.editUser=editUser,window.deleteUser=deleteUser,window.Users={initUsers:initUsers};