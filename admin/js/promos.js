let editingPromoId=null;async function initPromos(){await loadPromos(),setupPromosUI()}async function loadPromos(){renderPromos(await BackendData.loadData("promos"))}function renderPromos(promos){const list=document.getElementById("promosList");list&&(0!==promos.length?list.innerHTML=promos.map(p=>`\n    <div class="list-item">\n      <div class="list-item-info">\n        <div class="list-item-title">${AdminUtils.escapeHtml(p.code)}</div>\n        <div class="list-item-meta">${"percent"===p.type?p.value+"%":p.value+"€"} - ${p.enabled?"Actif":"Inactif"}</div>\n      </div>\n      <div class="list-item-actions">\n        <button class="btn-secondary" onclick="editPromo(${p.id})">Modifier</button>\n        <button class="btn-danger" onclick="deletePromo(${p.id})">Supprimer</button>\n      </div>\n    </div>\n  `).join(""):list.innerHTML='<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucun code promo</div>')}function setupPromosUI(){const addBtn=document.getElementById("addPromoBtn");addBtn&&addBtn.addEventListener("click",()=>{openPromoModal()}),modalManager.setupModal("promoModal",savePromo,()=>{editingPromoId=null,resetForm("promoForm")});const codeInput=document.getElementById("promoCode");codeInput&&codeInput.addEventListener("input",e=>{e.target.value=e.target.value.toUpperCase()});const typeSelect=document.getElementById("promoType"),valueLabel=document.getElementById("promoValueLabel"),valueHelp=document.getElementById("promoValueHelp");typeSelect&&valueLabel&&valueHelp&&typeSelect.addEventListener("change",()=>{"percent"===typeSelect.value?(valueLabel.textContent="Pourcentage (%) *",valueHelp.textContent="Ex: 10 pour 10% de réduction"):"fixed"===typeSelect.value&&(valueLabel.textContent="Montant (€) *",valueHelp.textContent="Ex: 5 pour 5€ de réduction")})}function openPromoModal(promo=null){editingPromoId=promo?.id||null,document.getElementById("promoModal");const title=document.getElementById("promoModalTitle"),codeInput=document.getElementById("promoCode"),typeSelect=document.getElementById("promoType"),valueInput=document.getElementById("promoValue"),enabledCheckbox=document.getElementById("promoEnabled");promo?(title.textContent="Modifier le code promo",codeInput.value=promo.code||"",typeSelect.value=promo.type||"percent",valueInput.value=promo.value||"",enabledCheckbox.checked=!1!==promo.enabled,codeInput.setAttribute("data-editing-id",promo.id)):(title.textContent="Ajouter un code promo",codeInput.value="",typeSelect.value="percent",valueInput.value="",enabledCheckbox.checked=!0,codeInput.removeAttribute("data-editing-id")),typeSelect.dispatchEvent(new Event("change")),modalManager.open("promoModal")}async function savePromo(){const codeInput=document.getElementById("promoCode"),typeSelect=document.getElementById("promoType"),valueInput=document.getElementById("promoValue"),enabledCheckbox=document.getElementById("promoEnabled"),code=codeInput.value.trim().toUpperCase(),type=typeSelect.value,value=parseFloat(valueInput.value),enabled=enabledCheckbox.checked;if(!code)return AdminUtils.showToast("Le code est requis","error"),codeInput.focus(),!1;if(!type)return AdminUtils.showToast("Le type est requis","error"),typeSelect.focus(),!1;if(isNaN(value)||value<=0)return AdminUtils.showToast("Valeur invalide","error"),valueInput.focus(),!1;if("percent"===type&&value>100)return AdminUtils.showToast("Le pourcentage ne peut pas dépasser 100%","error"),valueInput.focus(),!1;const promos=await BackendData.loadData("promos");if(editingPromoId){const promo=promos.find(p=>p.id===editingPromoId);if(promo){if(code!==promo.code&&promos.find(p=>p.code===code))return AdminUtils.showToast("Ce code existe déjà","error"),codeInput.focus(),!1;promo.code=code,promo.type=type,promo.value=value,promo.enabled=enabled,await BackendData.saveData("promos",promos),AdminUtils.showToast("Code promo modifié","success")}}else{if(promos.find(p=>p.code===code))return AdminUtils.showToast("Ce code existe déjà","error"),codeInput.focus(),!1;promos.push({id:Date.now(),code:code,type:type,value:value,enabled:enabled,createdAt:(new Date).toISOString()}),await BackendData.saveData("promos",promos),AdminUtils.showToast("Code promo ajouté","success")}return await loadPromos(),editingPromoId=null,resetForm("promoForm"),!0}async function editPromo(id){const promo=(await BackendData.loadData("promos")).find(p=>p.id===id);promo&&openPromoModal(promo)}async function deletePromo(id){if(!AdminUtils.confirmAction("Supprimer ce code promo?"))return;const filtered=(await BackendData.loadData("promos")).filter(p=>p.id!==id);await BackendData.saveData("promos",filtered),await loadPromos(),AdminUtils.showToast("Code promo supprimé","success")}window.editPromo=editPromo,window.deletePromo=deletePromo,window.Promos={initPromos:initPromos};