let editingPaymentId=null,editingTimeslotId=null,currentServiceType=null;async function initCartConfig(){await loadCartConfig(),setupCartConfigUI()}async function loadCartConfig(){const payments=await BackendData.loadData("payments"),services=await BackendData.loadData("cart_services"),timeslots=await BackendData.loadData("cart_slots"),config=await BackendData.loadData("config");renderPayments(Array.isArray(payments)?payments:[]),renderServices(services||{}),renderTimeslots(Array.isArray(timeslots)?timeslots:[]);const servicesData=services||{home:!0,postal:!0,meet:!0},serviceHomeEl=document.getElementById("serviceHome"),servicePostalEl=document.getElementById("servicePostal"),serviceMeetEl=document.getElementById("serviceMeet");serviceHomeEl&&(serviceHomeEl.checked=!1!==servicesData.home),servicePostalEl&&(servicePostalEl.checked=!1!==servicesData.postal),serviceMeetEl&&(serviceMeetEl.checked=!1!==servicesData.meet);const configData=config||{},deliveryFeeEl=document.getElementById("deliveryFee"),freeDeliveryThresholdEl=document.getElementById("freeDeliveryThreshold"),redirectUrlEl=document.getElementById("redirectUrl");deliveryFeeEl&&(deliveryFeeEl.value=configData.deliveryFee||""),freeDeliveryThresholdEl&&(freeDeliveryThresholdEl.value=configData.freeDeliveryThreshold||""),redirectUrlEl&&(redirectUrlEl.value=configData.redirectUrl||"")}async function saveCartConfig(){const services={home:!1!==document.getElementById("serviceHome")?.checked,postal:!1!==document.getElementById("servicePostal")?.checked,meet:!1!==document.getElementById("serviceMeet")?.checked},config=await BackendData.loadData("config"),deliveryFeeEl=document.getElementById("deliveryFee"),freeDeliveryThresholdEl=document.getElementById("freeDeliveryThreshold"),redirectUrlEl=document.getElementById("redirectUrl");deliveryFeeEl&&(config.deliveryFee=parseFloat(deliveryFeeEl.value)||0),freeDeliveryThresholdEl&&(config.freeDeliveryThreshold=parseFloat(freeDeliveryThresholdEl.value)||0),redirectUrlEl&&(config.redirectUrl=redirectUrlEl.value.trim()),await BackendData.saveData("cart_services",services),await BackendData.saveData("config",config)}function renderPayments(payments){const list=document.getElementById("paymentMethodsList");list&&(Array.isArray(payments)||(payments=[]),0!==payments.length?list.innerHTML=payments.map(p=>`\n    <div class="item-tag">\n      <span>${AdminUtils.escapeHtml(p.name)}</span>\n      <div class="item-tag-actions">\n        <div class="item-tag-toggle ${p.enabled?"active":""}" onclick="togglePayment(${p.id})"></div>\n        <button class="btn-secondary" onclick="editPayment(${p.id})">Modifier</button>\n        <button class="btn-danger" onclick="deletePayment(${p.id})">Supprimer</button>\n      </div>\n    </div>\n  `).join(""):list.innerHTML='<div class="empty-state">Aucun mode de paiement</div>')}function renderServices(services){const servicesData=services||{home:!0,postal:!0,meet:!0};["home","postal","meet"].forEach(serviceKey=>{const checkbox=document.getElementById(`service${serviceKey.charAt(0).toUpperCase()+serviceKey.slice(1)}`);if(checkbox){checkbox.checked=!1!==servicesData[serviceKey];const toggle=checkbox.closest(".item-tag-toggle");toggle&&(checkbox.checked?toggle.classList.add("active"):toggle.classList.remove("active"))}})}function renderTimeslots(timeslots){Array.isArray(timeslots)||(timeslots=[]);const serviceMap={home:"timeslotsListHome",postal:"timeslotsListPostal",meet:"timeslotsListMeet"};Object.keys(serviceMap).forEach(serviceKey=>{const listId=serviceMap[serviceKey],list=document.getElementById(listId);if(!list)return;const serviceTimeslots=timeslots.filter(t=>("delivery"===t.serviceType?"home":"meetup"===t.serviceType?"meet":t.serviceType||t.service)===serviceKey);0!==serviceTimeslots.length?list.innerHTML=serviceTimeslots.map(t=>`\n      <div class="item-tag">\n        <span>${AdminUtils.escapeHtml(t.time||t)}</span>\n        <div class="item-tag-actions">\n          <button class="btn-secondary" onclick="editTimeslot(${t.id})">Modifier</button>\n          <button class="btn-danger" onclick="deleteTimeslot(${t.id})">Supprimer</button>\n        </div>\n      </div>\n    `).join(""):list.innerHTML='<div class="empty-state" style="padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.9rem;">Aucun créneau configuré</div>'})}function setupCartConfigUI(){const addPaymentBtn=document.getElementById("addPaymentMethodBtn");addPaymentBtn&&addPaymentBtn.addEventListener("click",()=>{openPaymentModal()}),modalManager.setupModal("paymentModal",savePayment,()=>{editingPaymentId=null,resetForm("paymentForm")}),modalManager.setupModal("timeslotModal",saveTimeslot,()=>{editingTimeslotId=null,currentServiceType=null,resetForm("timeslotForm")}),["serviceHome","servicePostal","serviceMeet"].forEach(id=>{const el=document.getElementById(id);el&&el.addEventListener("change",async()=>{await saveCartConfig(),AdminUtils.showToast("Services sauvegardés","success");const toggle=el.closest(".item-tag-toggle");toggle&&(el.checked?toggle.classList.add("active"):toggle.classList.remove("active"))})});const saveRedirectBtn=document.getElementById("saveRedirectUrlBtn");saveRedirectBtn&&saveRedirectBtn.addEventListener("click",async()=>{await saveCartConfig(),AdminUtils.showToast("URL de redirection sauvegardée","success")}),["deliveryFee","freeDeliveryThreshold"].forEach(id=>{const el=document.getElementById(id);el&&el.addEventListener("blur",async()=>{await saveCartConfig()})})}function openPaymentModal(payment=null){editingPaymentId=payment?.id||null,document.getElementById("paymentModal");const title=document.getElementById("paymentModalTitle"),nameInput=document.getElementById("paymentName"),enabledCheckbox=document.getElementById("paymentEnabled");payment?(title.textContent="Modifier le mode de paiement",nameInput.value=payment.name||"",enabledCheckbox.checked=!1!==payment.enabled,nameInput.setAttribute("data-editing-id",payment.id)):(title.textContent="Ajouter un mode de paiement",nameInput.value="",enabledCheckbox.checked=!0,nameInput.removeAttribute("data-editing-id")),modalManager.open("paymentModal")}async function savePayment(){const nameInput=document.getElementById("paymentName"),enabledCheckbox=document.getElementById("paymentEnabled"),name=nameInput.value.trim();if(!name)return AdminUtils.showToast("Le nom est requis","error"),nameInput.focus(),!1;const payments=await BackendData.loadData("payments"),paymentsArray=Array.isArray(payments)?payments:[];if(editingPaymentId){const payment=paymentsArray.find(p=>p.id===editingPaymentId);if(payment){if(name!==payment.name&&paymentsArray.find(p=>p.name.toLowerCase()===name.toLowerCase()))return AdminUtils.showToast("Ce mode de paiement existe déjà","error"),nameInput.focus(),!1;payment.name=name,payment.enabled=enabledCheckbox.checked,await BackendData.saveData("payments",paymentsArray),renderPayments(paymentsArray),AdminUtils.showToast("Mode de paiement modifié","success")}}else{if(paymentsArray.find(p=>p.name.toLowerCase()===name.toLowerCase()))return AdminUtils.showToast("Ce mode de paiement existe déjà","error"),nameInput.focus(),!1;paymentsArray.push({id:Date.now(),name:name,enabled:enabledCheckbox.checked}),await BackendData.saveData("payments",paymentsArray),renderPayments(paymentsArray),AdminUtils.showToast("Mode de paiement ajouté","success")}return editingPaymentId=null,resetForm("paymentForm"),!0}async function togglePayment(id){const payments=await BackendData.loadData("payments"),paymentsArray=Array.isArray(payments)?payments:[],payment=paymentsArray.find(p=>p.id===id);payment&&(payment.enabled=!payment.enabled,await BackendData.saveData("payments",paymentsArray),renderPayments(paymentsArray))}async function editPayment(id){const payments=await BackendData.loadData("payments"),payment=(Array.isArray(payments)?payments:[]).find(p=>p.id===id);payment&&openPaymentModal(payment)}async function deletePayment(id){if(!AdminUtils.confirmAction("Supprimer ce mode de paiement?"))return;const payments=await BackendData.loadData("payments"),filtered=(Array.isArray(payments)?payments:[]).filter(p=>p.id!==id);await BackendData.saveData("payments",filtered),renderPayments(filtered),AdminUtils.showToast("Mode de paiement supprimé","success")}async function openTimeslotModal(timeslot=null,serviceType=null){editingTimeslotId=timeslot?.id||null,currentServiceType=serviceType||timeslot?.serviceType||timeslot?.service||null;const modal=document.getElementById("timeslotModal"),title=document.getElementById("timeslotModalTitle"),timeInput=document.getElementById("timeslotTime"),serviceSelect=document.getElementById("timeslotServiceType");if(!(modal&&title&&timeInput&&serviceSelect))return void console.error("Modal ou éléments non trouvés");const convertServiceType=type=>"delivery"===type?"home":"meetup"===type?"meet":type;if(timeslot){title.textContent="Modifier le créneau horaire",timeInput.value=timeslot.time||"";const convertedType=convertServiceType(timeslot.serviceType||timeslot.service);serviceSelect.value=convertedType||"",serviceSelect.disabled=!0}else title.textContent="Ajouter un créneau horaire",timeInput.value="",serviceSelect.value=currentServiceType?convertServiceType(currentServiceType):"",serviceSelect.disabled=!1;window.modalManager&&window.modalManager.open("timeslotModal")}async function saveTimeslot(){const timeInput=document.getElementById("timeslotTime"),serviceSelect=document.getElementById("timeslotServiceType");if(!timeInput||!serviceSelect)return!1;const time=timeInput.value.trim();if(!time)return AdminUtils.showToast("Le créneau est requis","error"),timeInput.focus(),!1;const serviceType=serviceSelect.value;if(!serviceType)return AdminUtils.showToast("Le type de service est requis","error"),serviceSelect.focus(),!1;if(!window.BackendData)return AdminUtils.showToast("BackendData non disponible","error"),!1;const timeslots=await window.BackendData.loadData("cart_slots"),timeslotsArray=Array.isArray(timeslots)?timeslots:[];if(editingTimeslotId){const timeslot=timeslotsArray.find(t=>t.id===editingTimeslotId);timeslot&&(timeslot.time=time,await window.BackendData.saveData("cart_slots",timeslotsArray),renderTimeslots(timeslotsArray),AdminUtils.showToast("Créneau modifié","success"))}else{const newTimeslot={id:Date.now(),time:time,serviceType:serviceType};timeslotsArray.push(newTimeslot),await window.BackendData.saveData("cart_slots",timeslotsArray),renderTimeslots(timeslotsArray),AdminUtils.showToast("Créneau ajouté","success")}return editingTimeslotId=null,currentServiceType=null,resetForm("timeslotForm"),window.modalManager&&window.modalManager.close("timeslotModal"),!0}async function editTimeslot(id){const timeslots=await window.BackendData.loadData("cart_slots"),timeslot=(Array.isArray(timeslots)?timeslots:[]).find(t=>t.id===id);timeslot&&openTimeslotModal(timeslot)}async function deleteTimeslot(id){if(!AdminUtils.confirmAction("Supprimer ce créneau?"))return;if(!window.BackendData)return void AdminUtils.showToast("BackendData non disponible","error");const timeslots=await window.BackendData.loadData("cart_slots"),filtered=(Array.isArray(timeslots)?timeslots:[]).filter(t=>t.id!==id);await window.BackendData.saveData("cart_slots",filtered),renderTimeslots(filtered),AdminUtils.showToast("Créneau supprimé","success")}window.togglePayment=togglePayment,window.editPayment=editPayment,window.deletePayment=deletePayment,window.editTimeslot=editTimeslot,window.deleteTimeslot=deleteTimeslot,window.openTimeslotModal=openTimeslotModal,window.CartConfig={initCartConfig:initCartConfig};