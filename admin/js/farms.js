let editingFarmId=null;async function initFarms(){await loadFarms(),await loadFarmsEnabled(),setupFarmsUI()}async function loadFarmsEnabled(){const enabled=!1!==await BackendData.loadData("farmsEnabled");document.getElementById("farmsEnabled").checked=enabled}async function loadFarms(){const farms=await BackendData.loadData("farms"),normalized=farms.map(f=>"string"==typeof f?{id:Date.now()+Math.random(),name:f,createdAt:(new Date).toISOString()}:f);normalized.length!==farms.length&&await BackendData.saveData("farms",normalized),renderFarms(normalized)}function renderFarms(farms){const list=document.getElementById("farmsList");list&&(0!==farms.length?list.innerHTML=farms.map(f=>`\n    <div class="list-item">\n      <div class="list-item-info">\n        <div class="list-item-title">${AdminUtils.escapeHtml(f.name)}</div>\n        <div class="list-item-meta">Créée le ${AdminUtils.formatDate(f.createdAt)}</div>\n      </div>\n      <div class="list-item-actions">\n        <button class="btn-secondary" onclick="editFarm(${f.id})">Modifier</button>\n        <button class="btn-danger" onclick="deleteFarm(${f.id})">Supprimer</button>\n      </div>\n    </div>\n  `).join(""):list.innerHTML='<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucune farm</div>')}function setupFarmsUI(){const addBtn=document.getElementById("addFarmBtn");addBtn&&addBtn.addEventListener("click",()=>{openFarmModal()});const enabledToggle=document.getElementById("farmsEnabled");enabledToggle&&enabledToggle.addEventListener("change",async e=>{const enabled=e.target.checked;await BackendData.saveData("farmsEnabled",enabled),localStorage.setItem("site_farmsEnabled",JSON.stringify(enabled)),window.dispatchEvent(new CustomEvent("adminDataUpdated",{detail:{key:"farmsEnabled",data:enabled}})),AdminUtils.showToast(enabled?"Farms activées":"Farms désactivées","success")}),modalManager.setupModal("farmModal",saveFarm,()=>{editingFarmId=null,resetForm("farmForm")})}function openFarmModal(farm=null){editingFarmId=farm?.id||null,document.getElementById("farmModal");const title=document.getElementById("farmModalTitle"),nameInput=document.getElementById("farmName");farm?(title.textContent="Modifier la farm",nameInput.value=farm.name||"",nameInput.setAttribute("data-editing-id",farm.id)):(title.textContent="Ajouter une farm",nameInput.value="",nameInput.removeAttribute("data-editing-id")),modalManager.open("farmModal")}async function saveFarm(){const nameInput=document.getElementById("farmName"),name=nameInput.value.trim();if(!name)return AdminUtils.showToast("Le nom est requis","error"),nameInput.focus(),!1;const farms=await BackendData.loadData("farms");if(editingFarmId){const farm=farms.find(f=>f.id===editingFarmId);farm&&(farm.name=name,await BackendData.saveData("farms",farms),AdminUtils.showToast("Farm modifiée","success"))}else{if(farms.find(f=>f.name.toLowerCase()===name.toLowerCase()))return AdminUtils.showToast("Cette farm existe déjà","error"),nameInput.focus(),!1;farms.push({id:Date.now(),name:name,createdAt:(new Date).toISOString()}),await BackendData.saveData("farms",farms),AdminUtils.showToast("Farm ajoutée","success")}return await loadFarms(),editingFarmId=null,resetForm("farmForm"),!0}async function editFarm(id){const farm=(await BackendData.loadData("farms")).find(f=>f.id===id);farm&&openFarmModal(farm)}async function deleteFarm(id){if(!AdminUtils.confirmAction("Supprimer cette farm?"))return;const filtered=(await BackendData.loadData("farms")).filter(f=>f.id!==id);await BackendData.saveData("farms",filtered),await loadFarms(),AdminUtils.showToast("Farm supprimée","success")}window.editFarm=editFarm,window.deleteFarm=deleteFarm,window.Farms={initFarms:initFarms};