async function initMessages(){await loadMessages(),setupMessagesUI()}async function loadMessages(){renderMessages(await BackendData.loadData("messages"))}function renderMessages(messages){const list=document.getElementById("adminMessagesList");if(!list)return;if(0===messages.length)return void(list.innerHTML='<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Aucun message</div>');const unread=messages.filter(m=>!m.read),read=messages.filter(m=>m.read);let html="";unread.length>0&&(html+='<div style="margin-bottom: 2rem;"><h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.2rem;">Non lus ('+unread.length+")</h3>",html+=unread.map(message=>renderMessageCard(message)).join(""),html+="</div>"),read.length>0&&(html+='<div style="margin-bottom: 2rem;"><h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.2rem;">Lus ('+read.length+")</h3>",html+=read.map(message=>renderMessageCard(message)).join(""),html+="</div>"),list.innerHTML=html,setupMessageActions()}function renderMessageCard(message){const date=new Date(message.createdAt).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}),readBadge=message.read?'<span style="background: #10b981; color: #fff; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">Lu</span>':'<span style="background: #fbbf24; color: #000; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">Non lu</span>';return`\n    <div class="list-item" data-message-id="${message.id}">\n      <div class="list-item-info" style="flex: 1;">\n        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">\n          <div class="list-item-title">@${AdminUtils.escapeHtml(message.telegramUsername)}</div>\n          ${readBadge}\n        </div>\n        <div class="list-item-meta" style="margin-bottom: 0.75rem; color: var(--text-secondary); white-space: pre-wrap;">\n          ${AdminUtils.escapeHtml(message.message)}\n        </div>\n        <div class="list-item-meta" style="margin-top: 0.5rem; color: var(--text-muted); font-size: 0.85rem;">\n          ${date}\n        </div>\n      </div>\n      <div class="list-item-actions">\n        ${message.read?"":`\n          <button class="btn-primary btn-small" onclick="markMessageAsRead(${message.id})">\n            <i class="material-icons" style="font-size: 18px;">check</i> Marquer comme lu\n          </button>\n        `}\n        <button class="btn-danger btn-small" onclick="deleteMessage(${message.id})">\n          <i class="material-icons" style="font-size: 18px;">delete</i> Supprimer\n        </button>\n      </div>\n    </div>\n  `}function setupMessagesUI(){const refreshBtn=document.getElementById("refreshMessagesBtn");refreshBtn&&refreshBtn.addEventListener("click",async()=>{refreshBtn.disabled=!0;const originalHTML=refreshBtn.innerHTML;if(refreshBtn.innerHTML='<i class="material-icons" style="animation: spin 1s linear infinite; display: inline-block;">refresh</i> <span>Chargement...</span>',!document.getElementById("spin-animation-style")){const style=document.createElement("style");style.id="spin-animation-style",style.textContent="@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }",document.head.appendChild(style)}try{await loadMessages(),AdminUtils.showToast("Messages rafraîchis","success"),window.Dashboard&&window.Dashboard.loadStats&&await window.Dashboard.loadStats()}catch(error){console.error("Erreur rafraîchissement messages:",error),AdminUtils.showToast("Erreur lors du rafraîchissement","error")}finally{refreshBtn.disabled=!1,refreshBtn.innerHTML=originalHTML}})}function setupMessageActions(){}async function markMessageAsRead(id){const messages=await BackendData.loadData("messages"),message=messages.find(m=>m.id===id);message&&(message.read=!0,await BackendData.saveData("messages",messages),window.backendAPI&&window.backendAPI.syncToSite&&window.backendAPI.syncToSite("messages",messages),AdminUtils.showToast("Message marqué comme lu","success"),await loadMessages(),window.Dashboard&&window.Dashboard.loadStats&&await window.Dashboard.loadStats())}async function deleteMessage(id){if(!confirm("Voulez-vous supprimer définitivement ce message ?"))return;const filtered=(await BackendData.loadData("messages")).filter(m=>m.id!==id);await BackendData.saveData("messages",filtered),window.backendAPI&&window.backendAPI.syncToSite&&window.backendAPI.syncToSite("messages",filtered),AdminUtils.showToast("Message supprimé","success"),await loadMessages(),window.Dashboard&&window.Dashboard.loadStats&&await window.Dashboard.loadStats()}window.Messages={initMessages:initMessages,markMessageAsRead:markMessageAsRead,deleteMessage:deleteMessage};