!function(){"use strict";function loadTimeslots(slots,serviceType){const timeslotList=document.getElementById("timeslotList");if(!timeslotList)return;if(!serviceType){const selectedServiceLabel=document.getElementById("selectedServiceLabel");if(selectedServiceLabel){const serviceText=selectedServiceLabel.textContent.toLowerCase();serviceText.includes("domicile")?serviceType="home":serviceText.includes("postal")?serviceType="postal":(serviceText.includes("rencontre")||serviceText.includes("meet"))&&(serviceType="meet")}if(!serviceType){const activeServiceCard=document.querySelector(".service-card.active, .service-card.selected");activeServiceCard&&(serviceType=activeServiceCard.dataset.service||activeServiceCard.getAttribute("data-service"))}serviceType||document.querySelectorAll(".service-card").forEach(card=>{(card.classList.contains("active")||card.classList.contains("selected")||card.style.backgroundColor||card.querySelector(".active"))&&(serviceType=card.dataset.service||card.getAttribute("data-service"))})}let slotsToLoad=slots||[];if(!slotsToLoad||0===slotsToLoad.length)try{const allSlotsData=localStorage.getItem("site_cart_slots");if(allSlotsData){const allSlots=JSON.parse(allSlotsData);Array.isArray(allSlots)&&allSlots.length>0&&serviceType&&(slotsToLoad=allSlots.filter(slot=>{if(!slot)return!1;const slotServiceType=slot.serviceType||slot.service;return"delivery"===slotServiceType?"home"===serviceType:"meetup"===slotServiceType?"meet"===serviceType:slotServiceType===serviceType}))}}catch(e){console.warn("Erreur chargement slots depuis localStorage:",e)}if((!slotsToLoad||0===slotsToLoad.length)&&serviceType)try{if("home"===serviceType){const deliverySlots=localStorage.getItem("site_cart_slots_delivery");if(deliverySlots){const parsed=JSON.parse(deliverySlots);Array.isArray(parsed)&&parsed.length>0&&(slotsToLoad=parsed)}}else if("meet"===serviceType){const meetupSlots=localStorage.getItem("site_cart_slots_meetup");if(meetupSlots){const parsed=JSON.parse(meetupSlots);Array.isArray(parsed)&&parsed.length>0&&(slotsToLoad=parsed)}}}catch(e){console.warn("Erreur chargement slots ancien format:",e)}if(!slotsToLoad||!Array.isArray(slotsToLoad)||0===slotsToLoad.length)return timeslotList.innerHTML='<button class="slot-btn" data-slot="flexible">Flexible √† convenir</button>',void attachTimeslotListeners();const slotsHtml=slotsToLoad.map(slot=>{const time=slot.time||slot;return`<button class="slot-btn" data-slot="${time}">${time}</button>`}).join("");timeslotList.innerHTML=slotsHtml+'<button class="slot-btn" data-slot="flexible">Flexible √† convenir</button>',attachTimeslotListeners()}function attachTimeslotListeners(){const timeslotList=document.getElementById("timeslotList"),recapTimeslot=document.getElementById("recapTimeslot");timeslotList&&timeslotList.querySelectorAll(".slot-btn").forEach(btn=>{const newBtn=btn.cloneNode(!0);btn.parentNode.replaceChild(newBtn,btn),newBtn.addEventListener("click",function(){timeslotList.querySelectorAll(".slot-btn").forEach(b=>b.classList.remove("active")),this.classList.add("active"),recapTimeslot&&(recapTimeslot.textContent=this.dataset.slot||this.textContent)})})}function updateCartServices(services){const serviceList=document.querySelector(".service-list");if(!serviceList)return;const servicesData=services||{home:!0,postal:!0,meet:!0},homeBtn=serviceList.querySelector('[data-service="home"]'),postalBtn=serviceList.querySelector('[data-service="postal"]'),meetBtn=serviceList.querySelector('[data-service="meet"]');homeBtn&&(!1===servicesData.home?(homeBtn.style.display="none",homeBtn.classList.add("hidden"),homeBtn.setAttribute("aria-hidden","true")):(homeBtn.style.display="",homeBtn.classList.remove("hidden"),homeBtn.removeAttribute("aria-hidden"))),postalBtn&&(!1===servicesData.postal?(postalBtn.style.display="none",postalBtn.classList.add("hidden"),postalBtn.setAttribute("aria-hidden","true")):(postalBtn.style.display="",postalBtn.classList.remove("hidden"),postalBtn.removeAttribute("aria-hidden"))),meetBtn&&(!1===servicesData.meet?(meetBtn.style.display="none",meetBtn.classList.add("hidden"),meetBtn.setAttribute("aria-hidden","true")):(meetBtn.style.display="",meetBtn.classList.remove("hidden"),meetBtn.removeAttribute("aria-hidden")))}function loadTimeslotsFromStorage(){loadTimeslots([],null);const serviceList=document.querySelector(".service-list");function setupServiceCardListeners(){document.querySelectorAll(".service-card").forEach(card=>{"true"!==card.dataset.listenerAttached&&(card.dataset.listenerAttached="true",card.addEventListener("click",function(){const service=this.dataset.service||this.getAttribute("data-service");service&&setTimeout(()=>{loadTimeslots([],service)},300)}))})}serviceList&&new MutationObserver(function(){setTimeout(()=>{loadTimeslots([],null)},100)}).observe(serviceList,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-service"]}),setupServiceCardListeners(),setTimeout(setupServiceCardListeners,500),setTimeout(setupServiceCardListeners,1e3);const horairePanel=document.querySelector('.cart-panel[data-panel="horaire"]');horairePanel&&new MutationObserver(function(){horairePanel.classList.contains("hidden")||setTimeout(()=>{loadTimeslots([],null)},200)}).observe(horairePanel,{attributes:!0,attributeFilter:["class"]})}function loadServicesFromStorage(){try{const servicesData=localStorage.getItem("site_cart_services");servicesData&&updateCartServices(JSON.parse(servicesData))}catch(e){console.error("Erreur chargement services:",e)}}function normalizePromos(promos){return Array.isArray(promos)?promos.map(promo=>{if(promo.discountType&&void 0!==promo.discount)return promo;const normalized={...promo};return"percent"===promo.type?normalized.discountType="percentage":"fixed"===promo.type?normalized.discountType="fixed":promo.discountType&&(normalized.discountType=promo.discountType),void 0!==promo.value?normalized.discount=promo.value:void 0!==promo.discount&&(normalized.discount=promo.discount),normalized}):promos}function updatePromos(promos){if(!Array.isArray(promos))return;const normalized=normalizePromos(promos);window.availablePromos=normalized,console.log("‚úÖ Codes promo normalis√©s:",normalized.length)}function loadPromosFromStorage(){try{const promosData=localStorage.getItem("site_promos");promosData&&updatePromos(JSON.parse(promosData))}catch(e){console.error("Erreur chargement codes promo:",e)}}function initPromoButton(){const applyBtn=document.getElementById("applyPromoBtn"),promoInput=document.getElementById("cartPromoCode"),promoStatus=document.getElementById("promoStatus");if(!applyBtn||!promoInput||!promoStatus)return void setTimeout(initPromoButton,200);const newBtn=applyBtn.cloneNode(!0);function applyPromoCode(){const codeInput=document.getElementById("cartPromoCode"),status=document.getElementById("promoStatus");if(!codeInput||!status)return;const code=codeInput.value.trim().toUpperCase();if(!code)return status.textContent="Veuillez entrer un code",void(status.className="muted");const promos=window.availablePromos||[];if(!Array.isArray(promos)||0===promos.length)return status.textContent="Aucun code promo disponible",status.className="error",void console.warn("‚ö†Ô∏è Aucun code promo disponible");let promo=promos.find(p=>{const promoCode=(p.code||"").toString().toUpperCase(),isEnabled=!1!==p.enabled;return promoCode===code&&isEnabled});if(!promo)return status.textContent="Code promo invalide",status.className="error",window.currentPromo=null,void(window.refreshCartUI&&window.refreshCartUI());if(promo.validUntil&&new Date(promo.validUntil)<new Date)return status.textContent="Code promo expir√©",status.className="error",window.currentPromo=null,void(window.refreshCartUI&&window.refreshCartUI());const normalizedPromo={...promo,discountType:promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),discount:void 0!==promo.discount?promo.discount:promo.value};if(window.currentPromo=normalizedPromo,window.availablePromos&&Array.isArray(window.availablePromos)){const index=window.availablePromos.findIndex(p=>p.id===normalizedPromo.id||p.code===normalizedPromo.code);index>=0&&(window.availablePromos[index]=normalizedPromo)}const total=(window.cart||[]).reduce((sum,item)=>sum+(item.price||0),0),discountType=normalizedPromo.discountType||("percent"===normalizedPromo.type?"percentage":"fixed"===normalizedPromo.type?"fixed":"percentage"),discount=void 0!==normalizedPromo.discount?normalizedPromo.discount:normalizedPromo.value;let discountAmount=0;total>0&&(discountAmount="percentage"===discountType?total*(discount/100):discount);let successMessage="";successMessage="percentage"===discountType?`‚úÖ Le code promo de ${discount}% a √©t√© ajout√©`:`‚úÖ Le code promo de ${discount}‚Ç¨ a √©t√© ajout√©`,total>0&&discountAmount>0&&(Math.max(0,total-discountAmount),successMessage="percentage"===discountType?`‚úÖ Le code promo de ${discount}% a √©t√© ajout√© (r√©duction de ${discountAmount.toFixed(2)}‚Ç¨)`:`‚úÖ Le code promo de ${discount}‚Ç¨ a √©t√© ajout√©`),status.textContent=successMessage,status.className="success",window.dispatchEvent(new CustomEvent("promoCodeApplied",{detail:{promo:normalizedPromo}})),window.refreshCartUI&&window.refreshCartUI(),setTimeout(function(){if(function(){if(!window.currentPromo||!window.cart)return;const cartTotalEl=document.getElementById("cartTotal"),total=(window.cart||[]).reduce((sum,item)=>sum+(item.price||0),0);if(cartTotalEl&&total>0){const promo=window.currentPromo,discountType=promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),discount=void 0!==promo.discount?promo.discount:promo.value;let discountAmount=0;discountAmount="percentage"===discountType?total*(discount/100):discount;const finalTotal=Math.max(0,total-discountAmount);cartTotalEl.textContent=`${total.toFixed(2)}‚Ç¨ ‚Üí ${finalTotal.toFixed(2)}‚Ç¨`,console.log("üí∞ R√©duction appliqu√©e:",{total:total,discount:discountAmount,final:finalTotal,promo:promo.code})}}(),window.currentPromo&&window.cart){const updatedTotal=(window.cart||[]).reduce((sum,item)=>sum+(item.price||0),0);if(updatedTotal>0){const promo=window.currentPromo,updatedDiscountType=promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),updatedDiscount=void 0!==promo.discount?promo.discount:promo.value;let updatedDiscountAmount=0;if(updatedDiscountAmount="percentage"===updatedDiscountType?updatedTotal*(updatedDiscount/100):updatedDiscount,Math.max(0,updatedTotal-updatedDiscountAmount),updatedDiscountAmount>0){const updatedStatus=document.getElementById("promoStatus");if(updatedStatus){const updatedDiscountType=promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),updatedDiscount=void 0!==promo.discount?promo.discount:promo.value;updatedStatus.textContent="percentage"===updatedDiscountType?`‚úÖ Le code promo de ${updatedDiscount}% a √©t√© ajout√© (r√©duction de ${updatedDiscountAmount.toFixed(2)}‚Ç¨)`:`‚úÖ Le code promo de ${updatedDiscount}‚Ç¨ a √©t√© ajout√©`,updatedStatus.className="success"}}}}},150),console.log("‚úÖ Code promo appliqu√©:",normalizedPromo)}applyBtn.parentNode.replaceChild(newBtn,applyBtn);const btn=document.getElementById("applyPromoBtn");btn&&btn.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),applyPromoCode()}),promoInput&&promoInput.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),applyPromoCode())}),console.log("‚úÖ Bouton code promo initialis√©")}window.addEventListener("storage",function(e){if("site_cart_slots"!==e.key&&"site_cart_slots_delivery"!==e.key&&"site_cart_slots_meetup"!==e.key||loadTimeslots([],null),"site_cart_services"===e.key)try{updateCartServices(JSON.parse(e.newValue))}catch(err){console.error("Erreur parsing cart_services:",err)}}),window.addEventListener("adminDataUpdated",function(e){"cart_slots"!==e.detail.key&&"cart_slots_delivery"!==e.detail.key&&"cart_slots_meetup"!==e.detail.key||loadTimeslots([],null),"cart_services"===e.detail.key&&updateCartServices(e.detail.data)}),window.addEventListener("storage",function(e){if("site_promos"===e.key)try{updatePromos(JSON.parse(e.newValue))}catch(err){console.error("Erreur parsing promos:",err)}}),window.addEventListener("adminDataUpdated",function(e){"promos"===e.detail.key&&updatePromos(e.detail.data)}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){setTimeout(()=>{loadTimeslotsFromStorage(),loadServicesFromStorage(),loadPromosFromStorage()},500)}):setTimeout(()=>{loadTimeslotsFromStorage(),loadServicesFromStorage(),loadPromosFromStorage()},500),window.availablePromos&&Array.isArray(window.availablePromos)&&updatePromos(window.availablePromos),window.loadTimeslots=loadTimeslots,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){setTimeout(initPromoButton,500)}):setTimeout(initPromoButton,500);const cartModal=document.getElementById("cartModal");cartModal&&new MutationObserver(function(mutations){cartModal.classList.contains("active")&&setTimeout(initPromoButton,100)}).observe(cartModal,{attributes:!0,attributeFilter:["class"]}),window.applyPromoDiscount=function(){if(!window.currentPromo||!window.cart)return;const cartTotalEl=document.getElementById("cartTotal"),promoStatus=document.getElementById("promoStatus"),total=(window.cart||[]).reduce((sum,item)=>sum+(item.price||0),0);if(cartTotalEl&&total>0){const promo=window.currentPromo,discountType=promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),discount=void 0!==promo.discount?promo.discount:promo.value;let discountAmount=0;discountAmount="percentage"===discountType?total*(discount/100):discount;const finalTotal=Math.max(0,total-discountAmount);cartTotalEl.textContent=`${total.toFixed(2)}‚Ç¨ ‚Üí ${finalTotal.toFixed(2)}‚Ç¨`,promoStatus&&discountAmount>0&&(promoStatus.textContent="percentage"===discountType?`‚úÖ Le code promo de ${discount}% a √©t√© ajout√© (r√©duction de ${discountAmount.toFixed(2)}‚Ç¨)`:`‚úÖ Le code promo de ${discount}‚Ç¨ a √©t√© ajout√©`,promoStatus.className="success"),console.log("üí∞ R√©duction appliqu√©e:",{total:total,discount:discountAmount,final:finalTotal,promo:promo.code})}},setTimeout(function(){if(window.refreshCartUI){const originalRefreshCartUI=window.refreshCartUI;window.refreshCartUI=function(){const result=originalRefreshCartUI.apply(this,arguments);return window.currentPromo&&window.cart&&window.applyPromoDiscount&&setTimeout(function(){window.applyPromoDiscount()},50),result},console.log("‚úÖ refreshCartUI patch√© pour utiliser window.currentPromo")}},1e3),setTimeout(function(){const applyBtn=document.getElementById("applyPromoBtn");if(applyBtn&&applyBtn.onclick){const originalOnClick=applyBtn.onclick;applyBtn.onclick=function(e){e.preventDefault(),e.stopPropagation();const promos=window.availablePromos||[];Array.isArray(promos)&&(window.availablePromos=normalizePromos(promos)),originalOnClick&&originalOnClick.call(this,e)}}},1500),console.log("‚úÖ Patch panier charg√©")}();