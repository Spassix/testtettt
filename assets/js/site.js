document.addEventListener("DOMContentLoaded",()=>{const M={accueil:document.getElementById("accueil"),boutique:document.getElementById("boutique"),contact:document.getElementById("contact")},T=Array.from(document.querySelectorAll(".bottom-nav .bottom-nav-item"));function b(e){Object.entries(M).forEach(([t,n])=>{n&&(n.style.display=t===e?"":"none")}),T.forEach(t=>t.classList.toggle("active",t.dataset.nav===e))}T.forEach(e=>e.addEventListener("click",()=>b(e.dataset.nav))),b("accueil");const i=document.getElementById("mobileNav"),w=document.getElementById("menuToggle"),N=document.getElementById("navClose");function O(){i&&(i.classList.remove("active"),setTimeout(()=>{i&&!i.classList.contains("active")&&(i.style.visibility="hidden",i.style.pointerEvents="none")},300))}function D(){document.querySelectorAll(".nav-item").forEach(e=>{e.removeEventListener("click",U),e.addEventListener("click",U)})}function U(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const t=e.currentTarget.dataset.category||"tous";i&&(i.classList.remove("active"),setTimeout(()=>{i&&(i.style.visibility="hidden",i.style.pointerEvents="none")},50)),b("boutique");const n=document.getElementById("filterCategory");return n&&(n.value="tous"===t?"tous":t),setTimeout(()=>{if(window.filterProductsByCategory)window.filterProductsByCategory(t);else{const c=localStorage.getItem("site_products");if(c)try{const o=JSON.parse(c),a=window.normalizeProducts?window.normalizeProducts(o):o,d="tous"===t?a:a.filter(r=>r.category===t);window.renderProducts&&window.renderProducts(d)}catch(o){console.error("Erreur filtrage produits:",o)}}},100),!1}w&&w.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),i&&(i.classList.add("active"),i.style.visibility="visible",i.style.pointerEvents="auto")}),N&&N.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),O()}),document.addEventListener("click",e=>{i&&i.classList.contains("active")&&!i.contains(e.target)&&!w.contains(e.target)&&O()}),D();const ie=new MutationObserver(()=>{D()}),R=document.querySelector(".nav-items");R&&ie.observe(R,{childList:!0});const V=document.getElementById("scrollItemA"),j=document.getElementById("scrollItemB");if(!localStorage.getItem("site_banner")){const e="Bienvenue chez ThePlug CoffeeShop â€” QualitÃ© Premium Â· Service rapide";V&&(V.textContent=e),j&&(j.textContent=e)}const z=document.getElementById("cartBtn"),v=document.getElementById("cartModal"),_=document.getElementById("cartClose"),A=document.getElementById("cartItems"),f=document.getElementById("cartTotal"),H=v?v.querySelector(".cart-overlay"):null,J=document.getElementById("continueShoppingBtn");function Q(){v&&v.classList.add("active")}function k(){v&&v.classList.remove("active")}z&&z.addEventListener("click",Q),_&&_.addEventListener("click",k),H&&H.addEventListener("click",k),J&&J.addEventListener("click",k);const l=[];window.cart=l;const x=["panier","service","horaire","adresse","envoi"];let u=0;const ae=Array.from(document.querySelectorAll(".cart-panel")),re=Array.from(document.querySelectorAll(".cart-steps .step")),Z=document.getElementById("cartNextLabel"),m=document.getElementById("checkoutBtn"),G=document.getElementById("cartBackBtn");function g(){const e=x[u],t=0===l.length;if(ae.forEach(n=>{const c=n.dataset.panel===e;n.classList.toggle("hidden",!c)}),re.forEach(n=>n.classList.toggle("active",n.dataset.step===e)),Z&&(Z.textContent=u===x.length-1?"Valider":"Continuer"),m){const n=t||0===u&&t;m.disabled=n,n?(m.style.opacity="0.5",m.style.cursor="not-allowed"):(m.style.opacity="1",m.style.cursor="pointer")}}window.checkoutBtn=m,m&&m.addEventListener("click",()=>{0!==l.length?u<x.length-1?(u++,g()):alert("RÃ©capitulatif copiÃ© ou prÃªt Ã  Ãªtre partagÃ©."):AdminUtils?.showToast?.("Le panier est vide","error")||alert("Votre panier est vide. Ajoutez des produits avant de continuer.")}),G&&G.addEventListener("click",()=>{u=Math.max(0,u-1),g()}),g();const K=document.getElementById("selectedServiceLabel"),h=document.getElementById("recapService");document.querySelectorAll(".service-card").forEach(e=>{e.addEventListener("click",()=>{const n={home:"Livraison Ã  domicile",postal:"Envoi postal",meet:"Point de rencontre"}[e.dataset.service||"â€”"]||"â€”";K&&(K.textContent=n),h&&(h.textContent=n),u=x.indexOf("horaire"),g()})});const y=document.getElementById("recapHoraire");document.querySelectorAll(".option-btn").forEach(e=>{e.addEventListener("click",()=>{y&&(y.textContent=e.dataset.horaire||e.textContent)})});const W=document.getElementById("customOptionInput"),X=document.getElementById("customOptionValidate");X&&X.addEventListener("click",()=>{const e=W&&W.value.trim()||"";e&&y&&(y.textContent=e)});const B=document.getElementById("recapTimeslot");document.querySelectorAll(".slot-btn").forEach(e=>{e.addEventListener("click",()=>{B&&(B.textContent=e.dataset.slot||e.textContent)})});const P=document.getElementById("addrLine"),S=document.getElementById("addrCity"),q=document.getElementById("addrZip"),$=document.getElementById("addrExtra"),C=document.getElementById("recapAddress");function se(){const o=[P?P.value.trim():"",S?S.value.trim():"",q?q.value.trim():"",$?$.value.trim():""].filter(Boolean);C&&(C.textContent=o.length?o.join(", "):"â€”")}[P,S,q,$].forEach(e=>e&&e.addEventListener("input",se));const Y=document.getElementById("copyRecapBtn"),L=document.getElementById("recapItems");Y&&Y.addEventListener("click",async()=>{const e=h?h.textContent:"â€”",t=y?y.textContent:"â€”",n=B?B.textContent:"â€”",c=C?C.textContent:"â€”",o=`Commande Mexicain59\nItems: ${(L?L.textContent.trim():"")||"â€”"}\nService: ${e}\nOption: ${t}\nCrÃ©neau: ${n}\nAdresse: ${c}`;try{await navigator.clipboard.writeText(o),alert("RÃ©cap copiÃ© dans le presse-papier")}catch{}});const F=document.getElementById("filterPanel"),ee=(document.getElementById("searchBtn"),document.getElementById("searchBar"),document.getElementById("filterReset"));(function(){const e=document.getElementById("searchBtn"),t=document.getElementById("filterPanel");e?t?(console.log("âœ… Bouton et panel trouvÃ©s, configuration..."),e.onclick=function(c){c.preventDefault(),c.stopPropagation(),console.log("ðŸ”˜ Bouton filtres cliquÃ©"),t.classList.remove("hidden");const o=!t.classList.contains("active");t.classList.toggle("active"),t.setAttribute("aria-hidden",o?"false":"true"),console.log("ðŸ“‹ Panel Ã©tat:",o?"OUVERT (espace crÃ©Ã©)":"FERMÃ‰ (espace supprimÃ©)"),o&&setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"nearest"})},100)},document.addEventListener("click",function(c){if(!t.classList.contains("active"))return;const o=c.target;t.contains(o)||e===o||e.contains(o)||(t.classList.remove("active"),t.classList.add("hidden"),t.setAttribute("aria-hidden","true"),console.log("ðŸ“‹ Panel fermÃ© par clic extÃ©rieur"))},!0),console.log("âœ… Configuration du bouton de filtres terminÃ©e")):console.error("âŒ filterPanel non trouvÃ©"):console.error("âŒ searchBtn non trouvÃ©")})(),document.addEventListener("keydown",e=>{"Escape"===e.key&&F&&F.classList.contains("active")&&(F.classList.remove("active"),document.body.style.overflow="")}),ee&&ee.addEventListener("click",()=>{const e=document.getElementById("filterCategory"),t=document.getElementById("filterFarm");e&&(e.value="tous"),t&&(t.value="")}),window.loadPaymentMethods=function(){try{const e=localStorage.getItem("site_payments");if(!e)return void console.log("âš ï¸ Aucun mode de paiement configurÃ©");const t=JSON.parse(e);if(!Array.isArray(t)||0===t.length)return void console.log("âš ï¸ Liste de modes de paiement vide");const n=t.filter(o=>!1!==o.enabled);if(0===n.length)return void console.log("âš ï¸ Aucun mode de paiement activÃ©");const c=document.querySelector(".paiement-buttons");if(!c)return void console.error("âŒ .paiement-buttons non trouvÃ©");c.innerHTML=n.map(o=>`\n        <button class="paiement-btn" data-payment-id="${o.id||""}" data-payment-name="${o.name||""}">\n          ${o.icon?`<i class="material-icons">${o.icon}</i>`:""}\n          <span>${o.name||"Paiement"}</span>\n        </button>\n      `).join(""),c.querySelectorAll(".paiement-btn").forEach(o=>{o.addEventListener("click",function(){c.querySelectorAll(".paiement-btn").forEach(a=>a.classList.remove("selected")),this.classList.add("selected"),(c.closest?c.closest("#paymentSection"):document.getElementById("paymentSection"))?.classList.remove("payment-required"),c.classList.remove("payment-required"),window.updateCheckoutButtonState&&window.updateCheckoutButtonState(),console.log("ðŸ’³ Mode de paiement sÃ©lectionnÃ©:",this.dataset.paymentName)})}),window.updateCheckoutButtonState&&window.updateCheckoutButtonState(),console.log("âœ… Modes de paiement chargÃ©s:",n.length)}catch(e){console.error("âŒ Erreur chargement modes de paiement:",e)}},loadPaymentMethods(),window.addEventListener("adminDataUpdated",e=>{"payments"===e.detail.key&&loadPaymentMethods()}),window.addEventListener("storage",e=>{"site_payments"===e.key&&loadPaymentMethods()});const te=document.getElementById("applyPromoBtn"),I=document.getElementById("cartPromoCode"),s=document.getElementById("promoStatus");let E=null;function ne(){if(!I||!s)return;const e=I.value.trim().toUpperCase();if(!e)return s.textContent="Veuillez entrer un code",void(s.className="muted");const t=(window.availablePromos||[]).find(n=>n.code&&n.code.toUpperCase()===e&&!1!==n.enabled);return t?t.validUntil&&new Date(t.validUntil)<new Date?(s.textContent="Code promo expirÃ©",s.className="error",E=null,void p()):(E=t,s.textContent=`Code promo "${t.code}" appliquÃ©: ${"percentage"===t.discountType?t.discount+"%":t.discount+"â‚¬"} de rÃ©duction`,s.className="success",void p()):(s.textContent="Code promo invalide",s.className="error",E=null,void p())}function p(){const e=0===l.length,t=l.reduce((a,d)=>a+(d.qty||1),0);cartCount&&(cartCount.textContent=String(t)),A&&(A.innerHTML=e?'<div class="empty-cart"><i class="material-icons">shopping_cart</i><p>Votre panier est vide</p></div>':l.map((a,d)=>`\n          <div class="cart-item">\n            <div style="flex: 1;">\n              <div class="ci-title">${a.title}</div>\n              <div class="ci-price">${a.price.toFixed(2)}â‚¬</div>\n            </div>\n            <button class="ci-remove" data-idx="${d}">Retirer</button>\n          </div>\n        `).join(""));const n=l.reduce((a,d)=>a+d.price,0);let c=n,o=0;E&&!e?(o="percentage"===E.discountType?n*(E.discount/100):E.discount,c=Math.max(0,n-o),f&&(f.textContent=`${n.toFixed(2)}â‚¬ â†’ ${c.toFixed(2)}â‚¬`)):(f&&(f.textContent=`${n.toFixed(2)}â‚¬`),E=null,s&&"success"===s.className&&(s.textContent="",s.className="muted")),L&&(L.textContent=l.map(a=>`${a.title} (${a.price.toFixed(2)}â‚¬)`).join(", ")),document.querySelectorAll(".ci-remove").forEach(a=>{a.addEventListener("click",()=>{const d=Number(a.getAttribute("data-idx"));if(Number.isNaN(d))return;const r=l[d];r?r.qty&&r.qty>1?(r.qty-=1,r.price=Math.max(0,(r.price||0)-(r.unitPrice||0)),r.title=r.category?`${r.category} x${r.qty}`:r.title,p()):(l.splice(d,1),p()):p()})}),e&&0!==u&&(u=0),g()}te&&te.addEventListener("click",ne),I&&I.addEventListener("keypress",e=>{"Enter"===e.key&&ne()}),window.refreshCartUI=p,window.openCart=Q,p()});