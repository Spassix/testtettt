!function(){"use strict";function getUserId(){if(window.Telegram?.WebApp?.initDataUnsafe?.user?.id){const telegramUserId=String(window.Telegram.WebApp.initDataUnsafe.user.id);return localStorage.setItem("user_id",telegramUserId),telegramUserId}let userId=localStorage.getItem("user_id");return userId||(userId="user_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),localStorage.setItem("user_id",userId)),userId}function initCartSync(){if("undefined"==typeof window||!window.cart)return void setTimeout(initCartSync,100);if(window._cartSyncInitialized)return;function debouncedSave(){clearTimeout(window._cartSaveTimeout),window._cartSaveTimeout=setTimeout(()=>{window.cart&&Array.isArray(window.cart)&&async function(cart){try{const userId=getUserId();if(!userId)return void console.warn("⚠️ Impossible de sauvegarder le panier : ID utilisateur manquant");const response=await fetch(`/api/user-cart/${encodeURIComponent(userId)}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(cart)});if(!response.ok)throw new Error(`Erreur HTTP: ${response.status}`);(await response.json()).success&&console.log("✅ Panier sauvegardé dans Redis")}catch(err){console.error("❌ Erreur sauvegarde panier Redis:",err)}}([...window.cart])},500)}window._cartSyncInitialized=!0,async function(){try{const userId=getUserId();if(!userId)return console.warn("⚠️ Impossible de charger le panier : ID utilisateur manquant"),[];const response=await fetch(`/api/user-cart/${encodeURIComponent(userId)}`);if(!response.ok){if(404===response.status)return[];throw new Error(`Erreur HTTP: ${response.status}`)}const cart=await response.json();return Array.isArray(cart)?(console.log("✅ Panier chargé depuis Redis:",cart.length,"produit(s)"),cart):[]}catch(err){return console.error("❌ Erreur chargement panier Redis:",err),[]}}().then(cart=>{cart&&cart.length>0&&Array.isArray(cart)&&(window.cart.splice(0,window.cart.length,...cart),window.refreshCartUI&&window.refreshCartUI(),window.dispatchEvent(new CustomEvent("cartUpdated")))});const originalCart=window.cart;window.cart=new Proxy(originalCart,{set:function(target,property,value){const result=Reflect.set(target,property,value);return debouncedSave(),result}}),window.addEventListener("cartUpdated",debouncedSave);const originalPush=Array.prototype.push,originalSplice=Array.prototype.splice,originalPop=Array.prototype.pop,originalShift=Array.prototype.shift,cartPush=function(...items){const result=originalPush.apply(this,items);return debouncedSave(),result},cartSplice=function(...args){const result=originalSplice.apply(this,args);return debouncedSave(),result},cartPop=function(){const result=originalPop.apply(this);return debouncedSave(),result},cartShift=function(){const result=originalShift.apply(this);return debouncedSave(),result};try{Object.defineProperty(window.cart,"push",{value:cartPush,writable:!0,configurable:!0}),Object.defineProperty(window.cart,"splice",{value:cartSplice,writable:!0,configurable:!0}),Object.defineProperty(window.cart,"pop",{value:cartPop,writable:!0,configurable:!0}),Object.defineProperty(window.cart,"shift",{value:cartShift,writable:!0,configurable:!0})}catch(e){console.warn("⚠️ Impossible de remplacer les méthodes du panier:",e)}console.log("✅ Synchronisation panier Redis activée")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initCartSync):initCartSync(),setTimeout(initCartSync,500),setTimeout(initCartSync,1e3)}();