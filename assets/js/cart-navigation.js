!function(){"use strict";const panels=["panier","service","horaire","adresse","envoi"];let isNavigating=!1,isInitialized=!1;function isPaymentSelected(){return!!document.querySelector(".paiement-btn.selected")}function promptPaymentSelection(){const section=document.getElementById("paymentSection");if(section){section.classList.add("payment-required");const buttons=section.querySelector(".paiement-buttons");buttons&&buttons.classList.add("payment-required"),setTimeout(()=>{section.classList.remove("payment-required"),buttons&&buttons.classList.remove("payment-required")},1200),section.scrollIntoView({behavior:"smooth",block:"center"})}window.AdminUtils?.showToast?window.AdminUtils.showToast("Sélectionnez un mode de paiement pour continuer","error"):alert("Veuillez sélectionner un mode de paiement pour continuer.")}function init(){isInitialized||(isInitialized=!0,setTimeout(function trySetup(){if(!document.getElementById("checkoutBtn"))return console.log("Bouton checkoutBtn pas encore disponible, nouvelle tentative..."),void setTimeout(trySetup,200);!function(){if(!document.getElementById("cartBackBtn"))return;const observer=new MutationObserver(()=>{updateBackButtonVisibility(),updateActiveStep()});panels.forEach(panelName=>{const panel=document.querySelector(`.cart-panel[data-panel="${panelName}"]`);panel&&observer.observe(panel,{attributes:!0,attributeFilter:["class"]})}),document.querySelectorAll(".cart-steps .step").forEach(step=>{observer.observe(step,{attributes:!0,attributeFilter:["class"]})}),updateBackButtonVisibility()}(),document.querySelectorAll(".cart-steps .step").forEach(step=>{const stepName=step.dataset.step;if(!stepName)return;const newStep=step.cloneNode(!0);step.parentNode.replaceChild(newStep,step),newStep.style.cursor="pointer",newStep.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation();const cart=window.cart||[];return"panier"!==stepName&&0===cart.length?(alert("Votre panier est vide. Ajoutez des produits avant de continuer."),!1):(navigateToPanel(stepName),!1)})}),function(){const checkoutBtn=document.getElementById("checkoutBtn");if(!checkoutBtn)return void console.warn("Bouton checkoutBtn non trouvé");const newCheckoutBtn=checkoutBtn.cloneNode(!0);checkoutBtn.parentNode.replaceChild(newCheckoutBtn,checkoutBtn),setTimeout(()=>{updateCheckoutButtonState()},10),newCheckoutBtn.addEventListener("click",function(e){try{if(0===(window.cart||[]).length||this.disabled)return e.preventDefault(),e.stopPropagation(),!1;const currentPanel=document.querySelector(".cart-panel:not(.hidden)");if(!currentPanel)return!0;const currentPanelName=currentPanel.dataset.panel;return"adresse"===currentPanelName?validateBeforeEnvoi()?(e.preventDefault(),e.stopPropagation(),navigateToPanel("envoi"),!1):(e.preventDefault(),e.stopPropagation(),!1):"panier"===currentPanelName?(e.preventDefault(),e.stopPropagation(),!(!isPaymentSelected()&&(promptPaymentSelection(),1)||(navigateToPanel("service"),1))):"service"===currentPanelName?(e.preventDefault(),e.stopPropagation(),navigateToPanel("horaire"),!1):"horaire"!==currentPanelName||(e.preventDefault(),e.stopPropagation(),navigateToPanel("adresse"),!1)}catch(error){return console.error("Erreur validation checkout:",error),!0}},!1)}(),updateBackButtonVisibility(),updateActiveStep(),updateCheckoutButtonState(),function(){let isUpdating=!1;const observer=new MutationObserver(()=>{isUpdating||(isUpdating=!0,setTimeout(()=>{updateActiveStep(),isUpdating=!1},50))});panels.forEach(panelName=>{const panel=document.querySelector(`.cart-panel[data-panel="${panelName}"]`);panel&&observer.observe(panel,{attributes:!0,attributeFilter:["class"]})})}(),function(){window.addEventListener("cartUpdated",()=>{updateActiveStep(),updateCheckoutButtonState()});let lastCartLength=(window.cart||[]).length;setInterval(()=>{const currentCartLength=(window.cart||[]).length;currentCartLength!==lastCartLength&&(lastCartLength=currentCartLength,updateActiveStep(),updateCheckoutButtonState())},500)}()},500))}function updateCheckoutButtonState(){const checkoutBtn=document.getElementById("checkoutBtn");if(!checkoutBtn)return;const cartNotEmpty=(window.cart||[]).length>0,currentPanel=document.querySelector(".cart-panel:not(.hidden)"),isOnPanier=!currentPanel||"panier"===currentPanel.dataset.panel,canProceed=cartNotEmpty&&(!isOnPanier||isPaymentSelected());checkoutBtn.disabled=!canProceed,checkoutBtn.setAttribute("aria-disabled",canProceed?"false":"true"),canProceed?(checkoutBtn.classList.remove("disabled"),checkoutBtn.classList.add("enabled"),checkoutBtn.style.pointerEvents="auto",checkoutBtn.style.cursor="pointer"):(checkoutBtn.classList.remove("enabled"),checkoutBtn.classList.add("disabled"),checkoutBtn.style.pointerEvents="none",checkoutBtn.style.cursor="not-allowed")}function updateBackButtonVisibility(){const cartBackBtn=document.getElementById("cartBackBtn");if(!cartBackBtn)return;const currentPanel=document.querySelector(".cart-panel:not(.hidden)");currentPanel&&("panier"!==currentPanel.dataset.panel?cartBackBtn.classList.add("show-back-btn"):cartBackBtn.classList.remove("show-back-btn"))}function navigateToPanel(panelName){if(isNavigating)console.warn("Navigation déjà en cours, ignorée");else try{isNavigating=!0;const cart=window.cart||[];if("panier"!==panelName&&0===cart.length)return alert("Votre panier est vide. Ajoutez des produits avant de continuer."),void(isNavigating=!1);const currentPanel=document.querySelector(".cart-panel:not(.hidden)");let currentIndex=0,currentPanelName="panier";currentPanel&&(currentPanelName=currentPanel.dataset.panel,currentIndex=panels.indexOf(currentPanelName));const targetIndex=panels.indexOf(panelName);if(-1===targetIndex)return void(isNavigating=!1);if("panier"!==panelName&&"panier"===currentPanelName&&!isPaymentSelected())return promptPaymentSelection(),void(isNavigating=!1);if("envoi"===panelName&&!validateBeforeEnvoi())return void(isNavigating=!1);if(currentIndex===targetIndex)return void(isNavigating=!1);document.querySelectorAll(".cart-panel").forEach(panel=>{panel.dataset.panel===panelName?panel.classList.remove("hidden"):panel.classList.add("hidden")}),document.querySelectorAll(".cart-steps .step").forEach(step=>{step.dataset.step===panelName?step.classList.add("active"):step.classList.remove("active")}),setTimeout(()=>{updateBackButtonVisibility(),updateActiveStep(),updateCheckoutButtonState(),isNavigating=!1},100)}catch(error){console.error("Erreur navigation panier:",error),isNavigating=!1;const panierPanel=document.querySelector('.cart-panel[data-panel="panier"]');panierPanel&&(document.querySelectorAll(".cart-panel").forEach(p=>p.classList.add("hidden")),panierPanel.classList.remove("hidden"),updateBackButtonVisibility(),updateActiveStep())}}function updateActiveStep(){const currentPanel=document.querySelector(".cart-panel:not(.hidden)");if(!currentPanel)return;const currentPanelName=currentPanel.dataset.panel,steps=document.querySelectorAll(".cart-steps .step"),isEmpty=0===(window.cart||[]).length,paymentMissing=!isPaymentSelected();steps.forEach(step=>{const stepName=step.dataset.step;stepName===currentPanelName?(step.classList.add("active"),step.setAttribute("aria-current","step")):(step.classList.remove("active"),step.removeAttribute("aria-current")),isEmpty&&"panier"!==stepName||!isEmpty&&paymentMissing&&["service","horaire","adresse","envoi"].includes(stepName)?(step.style.opacity="0.5",step.style.cursor="not-allowed",step.style.pointerEvents="none"):(step.style.opacity="",step.style.cursor="pointer",step.style.pointerEvents="")})}function validateBeforeEnvoi(){let serviceSelected=!1;const selectedServiceLabel=document.getElementById("selectedServiceLabel");if(selectedServiceLabel&&selectedServiceLabel.textContent&&"—"!==selectedServiceLabel.textContent.trim()&&""!==selectedServiceLabel.textContent.trim()&&"service sélectionné :"!==selectedServiceLabel.textContent.trim().toLowerCase()&&(serviceSelected=!0),serviceSelected||document.querySelector(".service-card.active, .service-card.selected")&&(serviceSelected=!0),!serviceSelected)return alert("Veuillez sélectionner un service"),navigateToPanel("service"),!1;if(!document.querySelector(".slot-btn.active"))return alert("Veuillez sélectionner un créneau horaire"),navigateToPanel("horaire"),!1;const addrLine=document.getElementById("addrLine"),addrCity=document.getElementById("addrCity"),addrZip=document.getElementById("addrZip");return addrLine&&addrLine.value.trim()?addrCity&&addrCity.value.trim()?!(!addrZip||!addrZip.value.trim())||(alert("Veuillez remplir le code postal"),navigateToPanel("adresse"),!1):(alert("Veuillez remplir la ville"),navigateToPanel("adresse"),!1):(alert("Veuillez remplir l'adresse"),navigateToPanel("adresse"),!1)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init(),window.navigateToCartPanel=navigateToPanel,window.updateCheckoutButtonState=updateCheckoutButtonState,console.log("✅ Navigation panier configurée")}();