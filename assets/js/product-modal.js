(()=>{function closeProductModal(){const modal=document.getElementById("productModal");modal&&(modal.classList.remove("open"),document.body.classList.remove("modal-open"),document.body.style.overflow="")}window.showProductModal=function(product){if(!product)return;const modal=document.getElementById("productModal"),title=document.getElementById("pmTitle"),tags=document.getElementById("pmTags"),info=document.getElementById("pmInfo"),qtyContainer=document.getElementById("pmQty"),selection=document.getElementById("pmSelection"),priceLabel=document.getElementById("pmPrice"),priceBar=document.querySelector(".pm-pricebar"),media=document.querySelector(".pm-media"),video=document.getElementById("pmVideo"),addButton=document.getElementById("pmAdd"),closeButton=document.getElementById("pmClose");if(!modal)return;if(title&&(title.textContent=product.name||"Produit"),tags){const chips=[];product.category&&chips.push(`<span class="pm-chip">${product.category}</span>`),product.farm&&chips.push(`<span class="pm-chip">${product.farm}</span>`),product.featured&&chips.push('<span class="pm-chip featured">⭐ En vedette</span>'),tags.innerHTML=chips.join("")}if(info){const infoText=product.description&&product.description.trim()||product.info&&product.info.trim()||"";info.style.display=infoText?"block":"none";if(infoText&&window.parseMarkdownItalic){info.innerHTML=window.parseMarkdownItalic(infoText)}else{info.textContent=infoText}}const normalizeUnit=value=>value&&value.replace(/^\d+/,"").trim()||"g",defaultUnit=normalizeUnit(product.unit||"g"),customPrices={};if(product.customPrices&&product.customPrices.split(",").forEach(entry=>{const trimmed=entry.trim();if(!trimmed.includes(":"))return;const parts=trimmed.split(":");if(2!==parts.length)return;const grammagePart=parts[0].trim(),pricePart=parts[1].trim();grammagePart&&pricePart&&!isNaN(parseFloat(grammagePart))&&!isNaN(parseFloat(pricePart))&&(customPrices[parseFloat(grammagePart)]=parseFloat(pricePart))}),product.quantities&&Array.isArray(product.quantities)&&product.quantities.length>0)product.quantities=product.quantities.map(item=>{const price=void 0!==customPrices[item.grammage]?customPrices[item.grammage]:(product.price||0)*item.grammage;return{...item,unit:normalizeUnit(item.unit||defaultUnit),price:price}});else if(product.grammages||product.customPrices){let grammages=[];product.grammages&&(grammages=product.grammages.split(",").map(value=>value.trim()).filter(value=>value&&!isNaN(parseFloat(value))).map(value=>parseFloat(value))),grammages.length>0&&(product.quantities=grammages.map(grammage=>{const price=void 0!==customPrices[grammage]?customPrices[grammage]:(product.price||0)*grammage;return{grammage:grammage,unit:defaultUnit,price:price}}),Object.keys(customPrices).forEach(key=>{const parsed=parseFloat(key);grammages.includes(parsed)||isNaN(parsed)||product.quantities.push({grammage:parsed,unit:defaultUnit,price:customPrices[parsed]})}),product.quantities.sort((a,b)=>a.grammage-b.grammage))}let selectedQuantity=null,selectedPrice=product.price||0;if(product.quantities&&product.quantities.length>0){if(qtyContainer){qtyContainer.innerHTML=`\n        <div class="pm-qty-select">\n          <div class="qty-options">\n            ${product.quantities.map(item=>`\n              <button class="qty-btn" data-grammage="${item.grammage}" data-price="${item.price}" data-unit="${normalizeUnit(item.unit||"g")}">\n                <span class="qty-grammage">${item.grammage}${normalizeUnit(item.unit||"g")}</span>\n                <span class="qty-price-label">${item.price.toFixed(2)}€</span>\n              </button>\n            `).join("")}\n          </div>\n        </div>\n      `,selectedQuantity=product.quantities[0],selectedPrice=selectedQuantity.price,qtyContainer.querySelectorAll(".qty-btn").forEach(button=>{button.addEventListener("click",()=>{qtyContainer.querySelectorAll(".qty-btn").forEach(btn=>btn.classList.remove("active")),button.classList.add("active");const grammage=button.dataset.grammage,price=parseFloat(button.dataset.price),unit=button.dataset.unit||defaultUnit;selectedQuantity={grammage:grammage,price:price,unit:unit},selectedPrice=price,selection&&(selection.textContent=`${grammage}${unit}`),priceLabel&&(priceLabel.textContent=`${price.toFixed(2)}€`)})});const defaultButton=qtyContainer.querySelector(".qty-btn");defaultButton&&(defaultButton.classList.add("active"),selection&&selectedQuantity&&(selection.textContent=`${selectedQuantity.grammage}${selectedQuantity.unit||defaultUnit}`))}}else qtyContainer&&(qtyContainer.innerHTML="");product.quantities&&0!==product.quantities.length?priceBar&&(priceBar.style.display="flex"):(selection&&(selection.textContent=""),priceBar&&(priceBar.style.display="none")),priceLabel&&(priceLabel.textContent=`${selectedPrice.toFixed(2)}€`);const image=document.getElementById("pmImage");if(media&&video&&image){const videoSrc=product.video||"",photoSrc=product.photo||product.image||product.media||"";videoSrc?(video.style.display="block",video.src=videoSrc,image.style.display="none"):photoSrc?(video.style.display="none",image.src=photoSrc,image.alt=product.name||"",image.style.display="block"):(video.style.display="none",image.style.display="none")}if(addButton){addButton.onclick=null,addButton.replaceWith(addButton.cloneNode(!0));let lock=!1;const newAddButton=document.getElementById("pmAdd");newAddButton&&(newAddButton.onclick=()=>{if(lock)return;lock=!0,setTimeout(()=>lock=!1,300);const category=product.category||"Sans catégorie";if(window.cart){const baseName=product.name||category,imageUrl=product.photo||product.image||product.media||"",variantLabel=selectedQuantity&&selectedQuantity.grammage?`${selectedQuantity.grammage}${selectedQuantity.unit||defaultUnit}`:"",productKey=[product.id||baseName,variantLabel].filter(Boolean).join("::")||baseName;let existingItem=window.cart.find(item=>item.productKey===productKey);if(existingItem||(existingItem=window.cart.find(item=>!(item.productKey||item.category!==category||item.variant&&item.variant!==variantLabel))),existingItem){const unitPrice=existingItem.unitPrice||selectedPrice;existingItem.qty=(existingItem.qty||1)+1,existingItem.unitPrice=unitPrice,existingItem.price=unitPrice*existingItem.qty,existingItem.name=existingItem.name||baseName,existingItem.title=existingItem.name,existingItem.image=existingItem.image||imageUrl,existingItem.variant=existingItem.variant||variantLabel,existingItem.category=existingItem.category||category,existingItem.unit=existingItem.unit||selectedQuantity?.unit||defaultUnit}else window.cart.push({productKey:productKey,productId:product.id||null,category:category,name:baseName,title:baseName,unitPrice:selectedPrice,qty:1,price:selectedPrice,image:imageUrl,variant:variantLabel,grammage:selectedQuantity?.grammage||null,unit:selectedQuantity?.unit||defaultUnit});window.dispatchEvent(new CustomEvent("cartUpdated")),window.refreshCartUI&&window.refreshCartUI()}closeProductModal(),window.openCart&&window.openCart()})}closeButton&&(closeButton.onclick=closeProductModal),modal.onclick=event=>{event.target===modal&&closeProductModal()},modal.classList.add("open"),document.body.classList.add("modal-open"),document.body.style.overflow="hidden"},window.closeProductModal=closeProductModal})();
