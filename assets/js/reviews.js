!function(){"use strict";let selectedRating=0,reviewPhotoFile=null,reviewPhotoUrl=null,initialized=!1;function setupEventListeners(){const addReviewBtn=document.getElementById("addReviewBtn");if(addReviewBtn){const newBtn=addReviewBtn.cloneNode(!0);addReviewBtn.parentNode.replaceChild(newBtn,addReviewBtn),newBtn.addEventListener("click",openReviewForm)}const reviewFormClose=document.getElementById("reviewFormClose");if(reviewFormClose){const newClose=reviewFormClose.cloneNode(!0);reviewFormClose.parentNode.replaceChild(newClose,reviewFormClose),newClose.addEventListener("click",closeReviewForm)}const reviewFormModal=document.getElementById("reviewFormModal");reviewFormModal&&reviewFormModal.addEventListener("click",function(e){e.target===reviewFormModal&&closeReviewForm()})}function updateStars(rating){document.querySelectorAll(".star-rating .star").forEach((star,index)=>{const starRating=index+1,icon=star.querySelector("i");starRating<=rating?(star.classList.add("filled"),icon&&(icon.textContent="star")):(star.classList.remove("filled"),icon&&(icon.textContent="star_border"))})}function openReviewForm(){const reviewFormModal=document.getElementById("reviewFormModal");reviewFormModal&&(reviewFormModal.style.display="flex",document.body.style.overflow="hidden")}function closeReviewForm(){const reviewFormModal=document.getElementById("reviewFormModal");reviewFormModal&&(reviewFormModal.style.display="none",document.body.style.overflow="",function(){selectedRating=0,reviewPhotoFile=null,reviewPhotoUrl=null;const reviewDescription=document.getElementById("reviewDescription");reviewDescription&&(reviewDescription.value="");const reviewPhoto=document.getElementById("reviewPhoto");reviewPhoto&&(reviewPhoto.value="");const reviewPhotoPreview=document.getElementById("reviewPhotoPreview");reviewPhotoPreview&&(reviewPhotoPreview.innerHTML="",reviewPhotoPreview.classList.remove("show")),updateStars(0);const ratingText=document.getElementById("ratingText");ratingText&&(ratingText.textContent="S√©lectionnez une note")}())}async function loadReviews(){try{const reviews=await loadReviewsData();console.log("üì• Donn√©es charg√©es:",reviews.length,"avis au total");const approvedReviews=reviews.filter(r=>"approved"===r.status);console.log("‚úÖ Avis approuv√©s:",approvedReviews.length),approvedReviews.forEach(review=>{review.photo&&console.log("üñºÔ∏è Avis",review.id,"a une photo:",review.photo)}),renderReviews(approvedReviews)}catch(error){console.error("Erreur chargement avis:",error),renderReviews([])}}async function loadReviewsData(){try{const response=await fetch("/api/db/reviews.json");if(response.ok){const data=await response.json();if(Array.isArray(data))return localStorage.setItem("site_reviews",JSON.stringify(data)),data}}catch(error){console.log("Chargement depuis API √©chou√©, utilisation du cache local")}const cached=localStorage.getItem("site_reviews");if(cached)try{return JSON.parse(cached)}catch(e){console.error("Erreur parsing reviews:",e)}return[]}function renderReviews(reviews){const reviewsList=document.getElementById("reviewsList");reviewsList&&(console.log("üìã Affichage de",reviews.length,"avis approuv√©s"),reviews.forEach(review=>{const hasPhoto=review.photo&&"string"==typeof review.photo&&""!==review.photo.trim();console.log("Avis:",review.id,"Photo:",hasPhoto?review.photo:"aucune","Type:",typeof review.photo)}),0!==reviews.length?reviewsList.innerHTML=reviews.map(review=>{const stars=Array.from({length:5},(_,i)=>{const filled=i<review.rating;return`<i class="material-icons ${filled?"star-filled":"star-empty"}">${filled?"star":"star_border"}</i>`}).join(""),date=new Date(review.createdAt).toLocaleDateString("fr-FR",{year:"numeric",month:"long",day:"numeric"}),photoUrl=review.photo||review.image||review.photoUrl||"",hasPhoto=photoUrl&&"string"==typeof photoUrl&&""!==photoUrl.trim()&&"null"!==photoUrl&&"undefined"!==photoUrl;console.log("üîç Avis",review.id,"- photoUrl:",photoUrl,"- hasPhoto:",hasPhoto,"- review object:",review);const photoHtml=hasPhoto?`\n        <div class="review-photo" onclick="window.open('${photoUrl.replace(/'/g,"\\'").replace(/"/g,"&quot;")}', '_blank')" title="Cliquer pour agrandir">\n          <img src="${photoUrl.replace(/'/g,"\\'").replace(/"/g,"&quot;")}" alt="Photo avis" \n               loading="lazy"\n               style="display: block; width: 100%; height: auto; max-height: 500px; object-fit: contain;"\n               onerror="console.error('‚ùå Erreur chargement photo:', '${photoUrl.replace(/'/g,"\\'").replace(/"/g,"&quot;")}'); this.style.border='2px solid red'; this.alt='Image non charg√©e'; this.style.display='none';">\n        </div>\n      `:"";return hasPhoto?console.log("‚úÖ Photo trouv√©e pour avis",review.id,":",photoUrl):console.log("‚ö†Ô∏è Pas de photo pour avis",review.id,"- photoUrl:",photoUrl,"- review.photo:",review.photo),`\n        <div class="review-card">\n          <div class="review-header">\n            <div class="review-author">\n              <div class="review-avatar">${review.author?review.author.charAt(0).toUpperCase():"A"}</div>\n              <div class="review-info">\n                <div class="review-name">${review.author||"Anonyme"}</div>\n                <div class="review-date">${date}</div>\n              </div>\n            </div>\n            <div class="review-stars">${stars}</div>\n          </div>\n          <div class="review-content">${function(text){const div=document.createElement("div");return div.textContent=text,div.innerHTML}(review.description)}</div>\n          ${photoHtml}\n        </div>\n      `}).join(""):reviewsList.innerHTML='\n        <div class="empty-reviews">\n          <i class="material-icons">rate_review</i>\n          <p>Aucun avis pour le moment</p>\n        </div>\n      ')}document.addEventListener("DOMContentLoaded",function(){initialized?setupEventListeners():(function(){const stars=document.querySelectorAll(".star-rating .star"),ratingText=document.getElementById("ratingText"),ratingLabels={0:"S√©lectionnez une note",1:"Tr√®s mauvais",2:"Mauvais",3:"Moyen",4:"Bon",5:"Excellent"};stars.forEach(star=>{star.addEventListener("click",function(){const rating=parseInt(this.dataset.rating);selectedRating=rating,updateStars(rating),ratingText&&(ratingText.textContent=ratingLabels[rating]||"")}),star.addEventListener("mouseenter",function(){var rating;rating=parseInt(this.dataset.rating),document.querySelectorAll(".star-rating .star").forEach((star,index)=>{const starRating=index+1,icon=star.querySelector("i");starRating<=rating?(star.style.color="#ffd700",icon&&(icon.textContent="star")):(star.style.color="rgba(255, 255, 255, 0.3)",icon&&(icon.textContent="star_border"))})})});const starRating=document.getElementById("starRating");starRating&&starRating.addEventListener("mouseleave",function(){updateStars(selectedRating),ratingText&&(ratingText.textContent=ratingLabels[selectedRating]||"")})}(),function(){const reviewPhoto=document.getElementById("reviewPhoto"),reviewPhotoBtn=document.getElementById("reviewPhotoBtn"),reviewPhotoPreview=document.getElementById("reviewPhotoPreview");reviewPhotoBtn&&reviewPhoto&&reviewPhotoBtn.addEventListener("click",function(){reviewPhoto.click()}),reviewPhoto&&reviewPhoto.addEventListener("change",function(e){const file=e.target.files[0];if(file){reviewPhotoFile=file;const reader=new FileReader;reader.onload=function(e){reviewPhotoUrl=e.target.result,reviewPhotoPreview&&(reviewPhotoPreview.innerHTML=`<img src="${reviewPhotoUrl}" alt="Aper√ßu">`,reviewPhotoPreview.classList.add("show"))},reader.readAsDataURL(file)}})}(),function(){const reviewForm=document.getElementById("reviewForm");reviewForm&&reviewForm.addEventListener("submit",async function(e){e.preventDefault(),await async function(){const reviewDescription=document.getElementById("reviewDescription"),description=reviewDescription?reviewDescription.value.trim():"";if(!description)return void alert("Veuillez remplir la description de l'avis");if(0===selectedRating)return void alert("Veuillez s√©lectionner une note");const submitBtn=document.getElementById("submitReviewBtn");submitBtn&&(submitBtn.disabled=!0,submitBtn.innerHTML='<i class="material-icons">hourglass_empty</i> Envoi en cours...');try{let photoUrl=null;reviewPhotoFile&&(photoUrl=await async function(file){try{const fileName=file.name||`review_${Date.now()}.jpg`,ext=fileName.includes(".")?fileName.split(".").pop():"jpg",pathname=`reviews/${(fileName.includes(".")?fileName.substring(0,fileName.lastIndexOf(".")):fileName).replace(/[^a-zA-Z0-9-_]/g,"_")}.${ext}`,arrayBuffer=await file.arrayBuffer(),response=await fetch("/api/blob-upload",{method:"POST",headers:{"x-vercel-blob-file-name":fileName,"x-vercel-blob-pathname":pathname,"Content-Type":file.type||"image/jpeg"},body:arrayBuffer});if(!response.ok){const errorData=await response.json().catch(()=>({}));throw new Error(errorData.error||"Erreur lors de l'upload de la photo")}const data=await response.json();return console.log("‚úÖ Photo upload√©e avec succ√®s:",data.url),data.url||null}catch(error){return console.error("Erreur upload photo:",error),null}}(reviewPhotoFile));const review={id:Date.now(),description:description,rating:selectedRating,photo:photoUrl,status:"pending",createdAt:(new Date).toISOString(),author:"Anonyme"};console.log("üìù Avis cr√©√© avec photo:",review),await async function(review){try{const reviews=await loadReviewsData();reviews.push(review);try{(await fetch("/api/db/reviews.json",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(reviews)})).ok||console.warn("Sauvegarde API √©chou√©e, utilisation du fallback")}catch(apiError){console.warn("Erreur API, utilisation du fallback:",apiError)}localStorage.setItem("site_reviews",JSON.stringify(reviews)),window.dispatchEvent(new CustomEvent("reviewsUpdated"))}catch(error){console.error("Erreur sauvegarde avis:",error);const reviews=await loadReviewsData();throw reviews.push(review),localStorage.setItem("site_reviews",JSON.stringify(reviews)),window.dispatchEvent(new CustomEvent("reviewsUpdated")),error}}(review),alert("Votre avis a √©t√© envoy√© et sera examin√© par l'administrateur."),closeReviewForm(),loadReviews()}catch(error){console.error("Erreur lors de l'envoi de l'avis:",error),alert("Une erreur est survenue. Veuillez r√©essayer.")}finally{submitBtn&&(submitBtn.disabled=!1,submitBtn.innerHTML='<i class="material-icons">send</i> Publier l\'avis')}}()})}(),setupEventListeners(),loadReviews(),initialized=!0)}),window.addEventListener("reviewsUpdated",loadReviews),window.addEventListener("storage",function(e){"site_reviews"===e.key&&(console.log("üîÑ Avis mis √† jour depuis l'admin"),loadReviews())}),window.addEventListener("adminDataUpdated",function(e){e.detail&&"reviews"===e.detail.key&&(console.log("üîÑ Avis mis √† jour depuis l'admin (m√™me onglet)"),loadReviews())}),window.loadReviews=loadReviews}();