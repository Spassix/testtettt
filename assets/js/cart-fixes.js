!function(){"use strict";function initCartFixes(){setTimeout(()=>{!function(){const horairePanel=document.querySelector('.cart-panel[data-panel="horaire"]');if(!horairePanel)return;Array.from(horairePanel.querySelectorAll("h4.cart-subtitle")).forEach(subtitle=>{const text=subtitle.textContent.trim();if(text.includes("Choisissez vos options d'envoi")||text.includes("options d'envoi")){const elementsToRemove=[];elementsToRemove.push(subtitle);let nextSibling=subtitle.nextElementSibling;for(;nextSibling;)if("horaireOptions"===nextSibling.id||nextSibling.classList.contains("option-list"))elementsToRemove.push(nextSibling),nextSibling=nextSibling.nextElementSibling;else{if(!nextSibling.classList.contains("custom-row"))break;elementsToRemove.push(nextSibling),nextSibling=nextSibling.nextElementSibling}elementsToRemove.forEach(el=>el.remove())}});const horaireOptions=document.getElementById("horaireOptions");if(horaireOptions){const prevSibling=horaireOptions.previousElementSibling;prevSibling&&"H4"===prevSibling.tagName&&(prevSibling.textContent.includes("options d'envoi")||prevSibling.textContent.includes("Choisissez vos options"))&&prevSibling.remove(),horaireOptions.remove();const customRow=document.querySelector("#customOptionInput")?.closest(".custom-row");customRow&&customRow.remove()}}(),function(){const horairePanel=document.querySelector('.cart-panel[data-panel="horaire"]');horairePanel&&horairePanel.querySelectorAll("h4.cart-subtitle").forEach(subtitle=>{const text=subtitle.textContent.trim();(text.includes("Choisissez un créneau de livraison")||text.includes("créneau de livraison"))&&(subtitle.textContent="Choisissez un créneau")})}(),function(){const editServiceBtn=document.getElementById("editServiceBtn");if(editServiceBtn){const newServiceBtn=editServiceBtn.cloneNode(!0);editServiceBtn.parentNode.replaceChild(newServiceBtn,editServiceBtn),newServiceBtn.addEventListener("click",function(e){e.preventDefault(),e.stopPropagation(),function(){const panels=["panier","service","horaire","adresse","envoi"],targetIndex=panels.indexOf("service");if(-1===targetIndex)return;const currentPanel=document.querySelector(".cart-panel:not(.hidden)");let currentIndex=0;if(currentPanel){const currentPanelName=currentPanel.dataset.panel;currentIndex=panels.indexOf(currentPanelName)}const clicksNeeded=currentIndex-targetIndex;if(clicksNeeded>0){const cartBackBtn=document.getElementById("cartBackBtn");if(cartBackBtn)for(let i=0;i<clicksNeeded;i++)setTimeout(()=>{cartBackBtn.click()},150*i)}else if(clicksNeeded<0){const checkoutBtn=document.getElementById("checkoutBtn");if(checkoutBtn)for(let i=0;i<Math.abs(clicksNeeded);i++)setTimeout(()=>{checkoutBtn.click()},150*i)}}()})}}(),function(){const copyRecapBtn=document.getElementById("copyRecapBtn");if(!copyRecapBtn)return;const newBtn=copyRecapBtn.cloneNode(!0);if(copyRecapBtn.parentNode.replaceChild(newBtn,copyRecapBtn),newBtn.addEventListener("click",async function(e){e.preventDefault(),e.stopPropagation();const recapService=document.getElementById("recapService"),recapTimeslot=(document.getElementById("recapHoraire"),document.getElementById("recapTimeslot")),recapAddress=document.getElementById("recapAddress"),recapItems=document.getElementById("recapItems"),cartTotal=document.getElementById("cartTotal"),service=recapService?recapService.textContent:"—",timeslot=recapTimeslot?recapTimeslot.textContent:"—",address=recapAddress?recapAddress.textContent:"—",items=recapItems?recapItems.textContent.trim():"—";let paymentMethod="—";const selectedPaymentBtn=document.querySelector(".paiement-btn.selected");selectedPaymentBtn&&(paymentMethod=selectedPaymentBtn.dataset.paymentName||selectedPaymentBtn.getAttribute("data-payment-name")||selectedPaymentBtn.textContent.trim()||"—");let promoText="",finalPrice="";if(window.currentPromo&&window.cart){const promo=window.currentPromo,discountType=promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),discount=void 0!==promo.discount?promo.discount:promo.value;promoText="percentage"===discountType?`Code promo: ${promo.code} (${discount}%)`:`Code promo: ${promo.code} (${discount}€)`;const total=window.cart.reduce((sum,item)=>sum+(item.price||0),0);let discountAmount=0;discountAmount="percentage"===discountType?total*(discount/100):discount,finalPrice=`Prix final: ${Math.max(0,total-discountAmount).toFixed(2)}€`}else cartTotal&&(finalPrice=`Total: ${cartTotal.textContent}`);const recap=`Commande ThePlug CoffeeShop\nItems: ${items}\nService: ${service}\nCréneau: ${timeslot}\nAdresse: ${address}\nMoyen de paiement: ${paymentMethod}\n${promoText?promoText+"\n":""}${finalPrice}`;try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(recap),alert("Récap copié dans le presse-papier");else{const textarea=document.createElement("textarea");textarea.value=recap,textarea.style.position="fixed",textarea.style.left="-999999px",textarea.style.top="-999999px",document.body.appendChild(textarea),textarea.focus(),textarea.select();try{const successful=document.execCommand("copy");if(document.body.removeChild(textarea),!successful)throw new Error("execCommand failed");alert("Récap copié dans le presse-papier")}catch(err){throw document.body.removeChild(textarea),err}}}catch(err){console.error("Erreur copie récap:",err),alert("Impossible de copier automatiquement. Voici le récapitulatif :\n\n"+recap)}}),window.refreshCartUI){const originalRefreshCartUI=window.refreshCartUI,escapeHtml=str=>str?String(str).replace(/[&<>"']/g,s=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[s]||s)):"",formatName=item=>item.name?item.name:item.title?item.title.replace(/\sx\d+$/i,"").trim()||item.title:"Produit",formatVariant=item=>item.variant?item.variant:item.grammage&&item.unit?`${item.grammage}${item.unit}`:"",renderCartItems=()=>{const cartItemsEl=document.getElementById("cartItems");if(!cartItemsEl)return;const cart=window.cart||[];0!==cart.length?(cartItemsEl.classList.add("enhanced-cart"),cartItemsEl.innerHTML=cart.map((item,index)=>{const name=formatName(item),qty=item.qty||1,variant=formatVariant(item),unitPrice=Math.max(0,item.unitPrice||(qty?(item.price||0)/qty:0)),lineTotal=Math.max(0,item.price||unitPrice*qty),imageUrl=item.image||item.photo||item.media||"",key=item.productKey||name||String(index),initial=escapeHtml(name.charAt(0).toUpperCase()||"?");return`\n        <div class="cart-item" data-key="${escapeHtml(key)}">\n          <div class="ci-media">${imageUrl?`<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(name)}">`:`<span class="ci-placeholder">${initial}</span>`}</div>\n          <div class="ci-details">\n            <div class="ci-title">${escapeHtml(name)}</div>\n            <div class="ci-meta">\n              <span class="ci-qty">x${qty}</span>\n              ${variant?`<span class="ci-variant">${escapeHtml(variant)}</span>`:""}\n              <span class="ci-unit">${unitPrice.toFixed(2)}€ / unité</span>\n            </div>\n          </div>\n          <div class="ci-actions">\n            <div class="ci-price">${lineTotal.toFixed(2)}€</div>\n            <button class="ci-remove" data-idx="${index}">Retirer</button>\n          </div>\n        </div>\n      `}).join(""),cartItemsEl.querySelectorAll(".ci-remove").forEach(btn=>{btn.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();const idx=Number(btn.dataset.idx);if(Number.isNaN(idx))return;const cartArray=window.cart||[],item=cartArray[idx];if(!item)return;let cartChanged=!1;const unitPrice=Math.max(0,item.unitPrice||(item.price||0)/(item.qty||1)||0);item.qty&&item.qty>1?(item.qty-=1,item.price=Math.max(0,unitPrice*item.qty),cartChanged=!0):(cartArray.splice(idx,1),cartChanged=!0),window.refreshCartUI&&window.refreshCartUI(),cartChanged&&window.dispatchEvent(new CustomEvent("cartUpdated"))})})):cartItemsEl.classList.remove("enhanced-cart")};window.refreshCartUI=function(){const result=originalRefreshCartUI.apply(this,arguments);try{renderCartItems()}catch(err){console.error("Erreur mise à jour affichage panier:",err)}try{const recapItems=document.getElementById("recapItems");if(recapItems&&window.cart){let recapText=window.cart.map(item=>{const name=formatName(item),qty=item.qty||1,variant=formatVariant(item);return`${name}${variant?` (${variant})`:""} x${qty} (${Math.max(0,item.price||0).toFixed(2)}€)`}).join(", ");if(window.currentPromo){const promo=window.currentPromo,discountType=promo.discountType||("percent"===promo.type?"percentage":"fixed"===promo.type?"fixed":"percentage"),discount=void 0!==promo.discount?promo.discount:promo.value,total=window.cart.reduce((sum,line)=>sum+(line.price||0),0);let discountAmount=0;discountAmount="percentage"===discountType?total*(discount/100):discount;const finalTotal=Math.max(0,total-discountAmount),label="percentage"===discountType?`${discount}%`:`${discount}€`;recapText+=` | Code promo: ${promo.code||""} (${label}) | Prix final: ${finalTotal.toFixed(2)}€`}recapItems.textContent=recapText}}catch(err){console.error("Erreur mise à jour récap panier:",err)}return window.updateCheckoutButtonState&&window.updateCheckoutButtonState(),result}}console.log("✅ Corrections panier appliquées")}()},500)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initCartFixes):initCartFixes()}();